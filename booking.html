<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©server un cours - YoTeacher</title>
    
    <!-- Meta tags -->
    <meta name="description" content="R√©servez votre cours de fran√ßais avec YoTeacher. Choisissez l'horaire qui vous convient.">
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon/favicon-16x16.png">
    <link rel="manifest" href="img/favicon/site.webmanifest">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/booking.css">
    <link rel="stylesheet" href="css/footer.css">
    
    <!-- JavaScript -->
    <script src="js/config.js" defer></script>
    <script src="js/supabase.js" defer></script>
    <script src="js/auth.js" defer></script>
    <script src="js/translation.js" defer></script>
    <script src="js/currency.js" defer></script>
    <script src="js/booking.js" defer></script>
    <script src="js/common.js" defer></script>
    
    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <!-- Logo -->
                <div class="logo">
                    <a href="index.html">
                        <span class="logo-text">Yo<span class="logo-accent">Teacher</span></span>
                    </a>
                </div>

                <!-- Desktop Navigation -->
                <nav class="desktop-nav">
                    <ul class="nav-links">
                        <li><a href="index.html#about">√Ä propos</a></li>
                        <li><a href="index.html#courses">Cours</a></li>
                        <li><a href="index.html#testimonials">T√©moignages</a></li>
                        <li><a href="dashboard.html">Dashboard</a></li>
                    </ul>
                </nav>

                <!-- Right side (Desktop) -->
                <div class="header-right-group">
                    <!-- Language Switcher (Desktop) -->
                    <div class="language-switcher" id="languageSwitcherDesktop">
                        <i class="fas fa-globe"></i>
                        <span>FR</span>
                    </div>

                    <!-- Login/Register (Desktop) -->
                    <div class="desktop-auth-buttons">
                        <a href="login.html" class="login-btn btn btn-outline">
                            <i class="fas fa-sign-in-alt"></i>
                            Connexion
                        </a>
                    </div>
                </div>

                <!-- Mobile Menu Button -->
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <div class="logo">
                <a href="index.html">
                    <span class="logo-text">Yo<span class="logo-accent">Teacher</span></span>
                </a>
            </div>
            <button class="mobile-menu-close" id="mobileMenuClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <nav class="mobile-nav">
            <ul class="mobile-nav-links">
                <li><a href="index.html#about">√Ä propos</a></li>
                <li><a href="index.html#courses">Cours</a></li>
                <li><a href="index.html#testimonials">T√©moignages</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
            </ul>
        </nav>
        
        <div class="mobile-menu-footer">
            <!-- Language Switcher (Mobile) -->
            <div class="mobile-language" id="languageSwitcherMobile">
                <i class="fas fa-globe"></i>
                <span>FR</span>
            </div>
            
            <!-- Login/Register (Mobile) -->
            <a href="login.html" class="mobile-login-btn-header btn btn-primary">
                <i class="fas fa-sign-in-alt"></i>
                Connexion
            </a>
        </div>
    </div>

    <!-- Overlay for Mobile Menu -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>

    <!-- Main Content -->
    <main class="booking-main">
        <div class="container">
            <!-- Progress Steps -->
            <div class="booking-progress" id="bookingProgress">
                <div class="progress-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Choisir un cr√©neau</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Informations personnelles</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Paiement</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Confirmation</div>
                </div>
            </div>

            <!-- Course Selection Header -->
            <div class="booking-header">
                <div class="course-type-header">
                    <h1 id="courseTypeTitle">Cours de Conversation</h1>
                    <p class="course-description" id="courseDescription">
                        Am√©liorez votre fluidit√© √† l'oral avec des conversations guid√©es sur des sujets vari√©s d'actualit√©.
                    </p>
                </div>
                
                <!-- Duration Selector (Visible only for non-essai) -->
                <div class="duration-selector" id="durationSelector" style="display: none;">
                    <label for="durationSelect">
                        <i class="far fa-clock"></i>
                        <span id="durationLabel">Dur√©e du cours:</span>
                    </label>
                    <select id="durationSelect" class="form-select">
                        <option value="30">30 minutes</option>
                        <option value="45" selected>45 minutes</option>
                        <option value="60">60 minutes</option>
                    </select>
                </div>
            </div>

            <div class="booking-container">
                <!-- Left Column: Calendar & Time Slots -->
                <div class="booking-left">
                    <!-- Date Navigation -->
                    <div class="date-navigation">
                        <button class="btn-date-nav" id="prevDate">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        
                        <div class="current-date-display" id="currentDateDisplay">
                            Aujourd'hui, <span id="currentDate">10 janvier 2026</span>
                        </div>
                        
                        <button class="btn-date-nav" id="nextDate">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <!-- Time Slots Container -->
                    <div class="time-slots-container" id="timeSlotsContainer">
                        <div class="loading-slots" id="loadingSlots">
                            <div class="loading-spinner"></div>
                            <p>Chargement des cr√©neaux disponibles...</p>
                        </div>
                        
                        <!-- Time slots will be inserted here -->
                        <div class="time-slots-grid" id="timeSlotsGrid"></div>
                        
                        <!-- No slots message -->
                        <div class="no-slots-message" id="noSlotsMessage" style="display: none;">
                            <i class="far fa-calendar-times"></i>
                            <h3>Aucun cr√©neau disponible</h3>
                            <p>Il n'y a pas de cr√©neau disponible pour cette date. Veuillez s√©lectionner une autre date.</p>
                        </div>
                    </div>

                    <!-- Debug Info (only in development) -->
                    <div class="debug-info" id="debugInfo" style="display: none;">
                        <h4><i class="fas fa-bug"></i> Informations de d√©bogage</h4>
                        <div class="debug-content" id="debugContent"></div>
                    </div>
                </div>

                <!-- Right Column: Booking Summary -->
                <div class="booking-right">
                    <div class="booking-summary" id="bookingSummary">
                        <h3><i class="fas fa-clipboard-check"></i> R√©capitulatif</h3>
                        
                        <div class="summary-content">
                            <!-- Course Type & Duration -->
                            <div class="summary-item">
                                <span class="summary-label">Type de cours:</span>
                                <span class="summary-value" id="summaryCourseType">-</span>
                            </div>
                            
                            <div class="summary-item">
                                <span class="summary-label">Dur√©e:</span>
                                <span class="summary-value" id="summaryDuration">-</span>
                            </div>
                            
                            <!-- Selected Date & Time -->
                            <div class="summary-item">
                                <span class="summary-label">Date:</span>
                                <span class="summary-value" id="summaryDate">Non s√©lectionn√©e</span>
                            </div>
                            
                            <div class="summary-item">
                                <span class="summary-label">Horaire:</span>
                                <span class="summary-value" id="summaryTime">-</span>
                            </div>
                            
                            <!-- Price -->
                            <div class="summary-item price-item">
                                <span class="summary-label">Prix:</span>
                                <span class="summary-value price-value" id="summaryPrice">-</span>
                                <span class="vip-indicator" id="vipIndicator" style="display: none;">VIP</span>
                            </div>
                            
                            <!-- Login Prompt for Guests -->
                            <div class="login-prompt" id="loginPrompt">
                                <div class="login-prompt-content">
                                    <i class="fas fa-user-circle"></i>
                                    <div>
                                        <h4>Connectez-vous pour r√©server</h4>
                                        <p>Vous devez √™tre connect√© pour r√©server un cours.</p>
                                    </div>
                                </div>
                                <a href="login.html?redirect=booking.html%3Ftype%3Dconversation" class="btn btn-primary btn-sm">
                                    Se connecter
                                </a>
                            </div>
                            
                            <!-- Forfait Selection -->
                            <div class="package-selector" id="packageSelector" style="display: none;">
                                <label for="packageSelect">
                                    <i class="fas fa-box"></i>
                                    <span>Souhaitez-vous un forfait?</span>
                                </label>
                                <select id="packageSelect" class="form-select">
                                    <option value="1" selected>Cours unique (1 cr√©dit)</option>
                                    <option value="10">Forfait 10 cours (-5%)</option>
                                </select>
                                <div class="package-info" id="packageInfo">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Le forfait 10 cours vous offre une r√©duction de 5% et les cr√©dits restent valables 6 mois.</span>
                                </div>
                            </div>
                            
                            <!-- Total Price (for packages) -->
                            <div class="summary-item total-price" id="totalPriceContainer" style="display: none;">
                                <span class="summary-label">Total:</span>
                                <span class="summary-value total-price-value" id="totalPrice">-</span>
                            </div>
                        </div>
                        
                        <!-- Booking Actions -->
                        <div class="booking-actions" id="bookingActions" style="display: none;">
                            <button class="btn btn-primary btn-book" id="bookButton" disabled>
                                <i class="far fa-calendar-check"></i>
                                <span>Confirmer la r√©servation</span>
                            </button>
                            
                            <div class="booking-notice">
                                <i class="fas fa-info-circle"></i>
                                <p>Vous serez redirig√© vers le paiement pour confirmer votre r√©servation.</p>
                            </div>
                        </div>
                        
                        <!-- User Info Form (Step 2) -->
                        <div class="user-info-form" id="userInfoForm" style="display: none;">
                            <h4><i class="fas fa-user-edit"></i> Vos informations</h4>
                            
                            <div class="form-group">
                                <label for="userName">Nom complet</label>
                                <input type="text" id="userName" class="form-input" placeholder="Votre nom complet">
                            </div>
                            
                            <div class="form-group">
                                <label for="userEmail">Email</label>
                                <input type="email" id="userEmail" class="form-input" placeholder="votre@email.com">
                            </div>
                            
                            <div class="form-group">
                                <label for="userNotes">Notes suppl√©mentaires (optionnel)</label>
                                <textarea id="userNotes" class="form-textarea" rows="3" placeholder="Pr√©cisez votre niveau, vos objectifs, ou toute autre information utile..."></textarea>
                            </div>
                            
                            <div class="form-actions">
                                <button class="btn btn-secondary" id="backToStep1">
                                    <i class="fas fa-arrow-left"></i>
                                    Retour
                                </button>
                                <button class="btn btn-primary" id="continueToPayment">
                                    <i class="fas fa-credit-card"></i>
                                    Proc√©der au paiement
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Help Section -->
                    <div class="help-section">
                        <div class="help-item">
                            <i class="fas fa-video"></i>
                            <div>
                                <h4>Cours en visioconf√©rence</h4>
                                <p>Les cours se d√©roulent sur Zoom. Un lien vous sera envoy√© par email apr√®s confirmation.</p>
                            </div>
                        </div>
                        
                        <div class="help-item">
                            <i class="fas fa-clock"></i>
                            <div>
                                <h4>Annulation flexible</h4>
                                <p>Annulez ou reportez gratuitement jusqu'√† 24h avant le cours.</p>
                            </div>
                        </div>
                        
                        <div class="help-item">
                            <i class="fas fa-headset"></i>
                            <div>
                                <h4>Besoin d'aide?</h4>
                                <p>Contactez-nous √† <a href="mailto:contact@yoteacher.com">contact@yoteacher.com</a></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <!-- Brand -->
                <div class="footer-brand">
                    <div class="logo">
                        <span class="logo-text">Yo<span class="logo-accent">Teacher</span></span>
                    </div>
                    <p class="footer-tagline">Apprenez le fran√ßais avec un professeur passionn√© et exp√©riment√©.</p>
                    
                    <div class="social-links">
                        <a href="#" class="social-link"><i class="fab fa-linkedin-in"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                
                <!-- Quick Links -->
                <div class="footer-links">
                    <h4>Navigation</h4>
                    <ul>
                        <li><a href="index.html">Accueil</a></li>
                        <li><a href="index.html#about">√Ä propos</a></li>
                        <li><a href="index.html#courses">Cours</a></li>
                        <li><a href="index.html#testimonials">T√©moignages</a></li>
                        <li><a href="dashboard.html">Dashboard</a></li>
                    </ul>
                </div>
                
                <!-- Legal -->
                <div class="footer-links">
                    <h4>L√©gal</h4>
                    <ul>
                        <li><a href="privacy.html">Confidentialit√©</a></li>
                        <li><a href="terms.html">Conditions d'utilisation</a></li>
                        <li><a href="cookies.html">Cookies</a></li>
                    </ul>
                </div>
                
                <!-- Contact -->
                <div class="footer-contact">
                    <h4>Contact</h4>
                    <div class="contact-info">
                        <p><i class="fas fa-envelope"></i> contact@yoteacher.com</p>
                        <p><i class="fas fa-globe"></i> 75 pays visit√©s</p>
                        <p><i class="fas fa-star"></i> 100% de satisfaction</p>
                    </div>
                </div>
            </div>
            
            <!-- Copyright -->
            <div class="footer-bottom">
                <p>&copy; 2025 YoTeacher. Tous droits r√©serv√©s.</p>
                <p>Apprendre le fran√ßais n'a jamais √©t√© aussi accessible.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script>
        // ===== GESTION DE LA PAGE BOOKING =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìÖ Initialisation de la page booking...');
            
            // Configuration initiale
            let currentState = {
                courseType: null,
                duration: null,
                selectedDate: null,
                selectedSlot: null,
                user: null,
                isVIP: false,
                packageQuantity: 1
            };
            
            // R√©cup√©rer les param√®tres d'URL
            const urlParams = new URLSearchParams(window.location.search);
            const courseTypeParam = urlParams.get('type') || 'essai';
            
            // Initialiser l'√©tat
            currentState.courseType = courseTypeParam;
            currentState.duration = courseTypeParam === 'essai' ? 15 : 60;
            
            // Initialiser l'interface
            await initializePage();
            
            // ===== FONCTIONS D'INITIALISATION =====
            async function initializePage() {
                console.log('üîß Initialisation de la page...');
                
                // Afficher le type de cours
                updateCourseTypeDisplay(currentState.courseType);
                
                // Initialiser les √©couteurs d'√©v√©nements
                setupEventListeners();
                
                // Mettre √† jour l'interface utilisateur
                await updateUserInterface();
                
                // Charger les cr√©neaux pour aujourd'hui
                await loadAvailableSlots(getTodayDateString());
                
                // Mettre √† jour le r√©sum√©
                updateSummary();
                
                console.log('‚úÖ Page booking initialis√©e');
            }
            
            function updateCourseTypeDisplay(courseType) {
                const titles = {
                    'essai': 'Cours d\'essai gratuit',
                    'conversation': 'Cours de Conversation',
                    'curriculum': 'Curriculum Complet',
                    'examen': 'Pr√©paration d\'examen'
                };
                
                const descriptions = {
                    'essai': 'D√©couvrez ma m√©thode d\'enseignement avec un cours d\'essai gratuit de 15 minutes.',
                    'conversation': 'Am√©liorez votre fluidit√© √† l\'oral avec des conversations guid√©es sur des sujets vari√©s d\'actualit√©.',
                    'curriculum': 'Approfondissez votre ma√Ætrise du fran√ßais avec un programme structur√© de grammaire et d\'exercices.',
                    'examen': 'Pr√©parez-vous efficacement aux examens DELF, DALF ou TCF avec des simulations et corrections.'
                };
                
                // Mettre √† jour le titre et la description
                document.getElementById('courseTypeTitle').textContent = titles[courseType] || 'Cours de fran√ßais';
                document.getElementById('courseDescription').textContent = descriptions[courseType] || '';
                
                // Afficher/masquer le s√©lecteur de dur√©e
                const durationSelector = document.getElementById('durationSelector');
                if (courseType === 'essai') {
                    durationSelector.style.display = 'none';
                    currentState.duration = 15;
                } else {
                    durationSelector.style.display = 'flex';
                    
                    // Configurer les options de dur√©e
                    const durationSelect = document.getElementById('durationSelect');
                    durationSelect.innerHTML = '';
                    
                    const durationOptions = window.bookingManager?.getDurationOptions(courseType) || [30, 45, 60];
                    durationOptions.forEach(duration => {
                        const option = document.createElement('option');
                        option.value = duration;
                        option.textContent = `${duration} minutes`;
                        if (duration === currentState.duration) {
                            option.selected = true;
                        }
                        durationSelect.appendChild(option);
                    });
                }
            }
            
            function setupEventListeners() {
                console.log('üîß Configuration des √©couteurs d\'√©v√©nements...');
                
                // Navigation des dates
                document.getElementById('prevDate').addEventListener('click', () => navigateDate(-1));
                document.getElementById('nextDate').addEventListener('click', () => navigateDate(1));
                
                // S√©lection de dur√©e
                const durationSelect = document.getElementById('durationSelect');
                if (durationSelect) {
                    durationSelect.addEventListener('change', async function() {
                        currentState.duration = parseInt(this.value);
                        console.log(`üïê Dur√©e chang√©e: ${currentState.duration} min`);
                        
                        // Recharger les cr√©neaux pour la dur√©e s√©lectionn√©e
                        if (currentState.selectedDate) {
                            await loadAvailableSlots(currentState.selectedDate);
                        }
                        
                        // Mettre √† jour le r√©sum√©
                        updateSummary();
                        await updateUserInterface();
                    });
                }
                
                // S√©lection de forfait
                const packageSelect = document.getElementById('packageSelect');
                if (packageSelect) {
                    packageSelect.addEventListener('change', function() {
                        currentState.packageQuantity = parseInt(this.value);
                        console.log(`üì¶ Quantit√© de forfait chang√©e: ${currentState.packageQuantity}`);
                        updateSummary();
                    });
                }
                
                // Bouton de r√©servation
                const bookButton = document.getElementById('bookButton');
                if (bookButton) {
                    bookButton.addEventListener('click', async function() {
                        await proceedToBooking();
                    });
                }
                
                // Navigation dans les √©tapes
                const backToStep1 = document.getElementById('backToStep1');
                if (backToStep1) {
                    backToStep1.addEventListener('click', () => goToStep(1));
                }
                
                const continueToPayment = document.getElementById('continueToPayment');
                if (continueToPayment) {
                    continueToPayment.addEventListener('click', async () => {
                        await proceedToPayment();
                    });
                }
                
                // Menu mobile
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                const mobileMenuClose = document.getElementById('mobileMenuClose');
                const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
                const mobileMenu = document.getElementById('mobileMenu');
                
                if (mobileMenuBtn) {
                    mobileMenuBtn.addEventListener('click', () => {
                        mobileMenu.classList.add('active');
                        mobileMenuOverlay.classList.add('active');
                    });
                }
                
                if (mobileMenuClose) {
                    mobileMenuClose.addEventListener('click', () => {
                        mobileMenu.classList.remove('active');
                        mobileMenuOverlay.classList.remove('active');
                    });
                }
                
                if (mobileMenuOverlay) {
                    mobileMenuOverlay.addEventListener('click', () => {
                        mobileMenu.classList.remove('active');
                        mobileMenuOverlay.classList.remove('active');
                    });
                }
                
                // √âcouter les √©v√©nements d'authentification
                window.addEventListener('auth:login', async function(e) {
                    console.log('üîê Connexion d√©tect√©e, mise √† jour de l\'interface');
                    currentState.user = e.detail?.user;
                    currentState.isVIP = currentState.user?.profile?.is_vip === true;
                    await updateUserInterface();
                });
                
                window.addEventListener('auth:logout', async function() {
                    console.log('üîì D√©connexion d√©tect√©e');
                    currentState.user = null;
                    currentState.isVIP = false;
                    await updateUserInterface();
                });
                
                // √âcouter les √©v√©nements de prix VIP
                window.addEventListener('vip:loaded', async function() {
                    console.log('üéÅ Prix VIP charg√©s dans booking.html, mise √† jour des prix');
                    await updateUserInterface();
                    updateSummary();
                });
                
                console.log('‚úÖ √âcouteurs d\'√©v√©nements configur√©s');
            }
            
            async function updateUserInterface() {
                console.log('üîÑ Mise √† jour de l\'interface utilisateur...');
                
                // V√©rifier l'utilisateur
                if (!currentState.user && window.authManager) {
                    currentState.user = window.authManager.getCurrentUser();
                    currentState.isVIP = window.authManager.isUserVip();
                }
                
                console.log('üë§ Utilisateur connect√©:', !!currentState.user, 'VIP:', currentState.isVIP);
                
                // Afficher/masquer les √©l√©ments en fonction de l'√©tat
                const loginPrompt = document.getElementById('loginPrompt');
                const bookingActions = document.getElementById('bookingActions');
                const userInfoForm = document.getElementById('userInfoForm');
                const packageSelector = document.getElementById('packageSelector');
                
                if (currentState.user) {
                    // Utilisateur connect√©
                    loginPrompt.style.display = 'none';
                    
                    // Afficher le s√©lecteur de forfait pour les cours payants
                    if (currentState.courseType !== 'essai') {
                        packageSelector.style.display = 'block';
                    } else {
                        packageSelector.style.display = 'none';
                    }
                    
                    // Afficher les actions de r√©servation si un cr√©neau est s√©lectionn√©
                    if (currentState.selectedSlot) {
                        bookingActions.style.display = 'block';
                        userInfoForm.style.display = 'none';
                    } else {
                        bookingActions.style.display = 'none';
                        userInfoForm.style.display = 'none';
                    }
                } else {
                    // Utilisateur non connect√©
                    loginPrompt.style.display = 'flex';
                    bookingActions.style.display = 'none';
                    userInfoForm.style.display = 'none';
                    packageSelector.style.display = 'none';
                }
                
                // Mettre √† jour l'indicateur VIP
                const vipIndicator = document.getElementById('vipIndicator');
                if (currentState.isVIP) {
                    vipIndicator.style.display = 'inline-block';
                } else {
                    vipIndicator.style.display = 'none';
                }
                
                // Mettre √† jour l'affichage des prix
                await updatePriceDisplay();
                
                console.log('‚úÖ Interface utilisateur mise √† jour');
            }
            
            async function updatePriceDisplay() {
                const priceElement = document.getElementById('summaryPrice');
                const totalPriceElement = document.getElementById('totalPrice');
                const totalPriceContainer = document.getElementById('totalPriceContainer');
                
                if (!currentState.duration || !currentState.courseType) {
                    priceElement.textContent = '-';
                    return;
                }
                
                try {
                    let price = 0;
                    let isVIPPrice = false;
                    
                    // R√©cup√©rer le prix selon le type d'utilisateur
                    if (currentState.isVIP && currentState.courseType !== 'essai') {
                        // Prix VIP
                        const vipPrice = await window.authManager?.getVipPrice(currentState.courseType, currentState.duration);
                        
                        if (vipPrice && vipPrice.price !== undefined && !isNaN(vipPrice.price)) {
                            price = vipPrice.price;
                            isVIPPrice = true;
                            console.log('üí∞ Prix VIP trouv√©:', price, vipPrice.currency);
                        } else {
                            // Fallback au prix normal si pas de prix VIP
                            price = getDefaultPrice(currentState.courseType, currentState.duration);
                            console.log('‚ö†Ô∏è Prix VIP non trouv√©, utilisation prix normal:', price);
                        }
                    } else {
                        // Prix normal
                        price = getDefaultPrice(currentState.courseType, currentState.duration);
                    }
                    
                    // Appliquer la quantit√© de forfait
                    const totalPrice = price * currentState.packageQuantity;
                    
                    // Appliquer la r√©duction de forfait
                    let finalPrice = totalPrice;
                    if (currentState.packageQuantity > 1) {
                        finalPrice = totalPrice * 0.95; // 5% de r√©duction
                    }
                    
                    // Formater le prix
                    let displayPrice, displayTotalPrice;
                    
                    if (window.currencyManager) {
                        displayPrice = window.currencyManager.formatPrice(price);
                        displayTotalPrice = window.currencyManager.formatPrice(finalPrice);
                    } else {
                        displayPrice = `${price.toFixed(2)} ‚Ç¨`;
                        displayTotalPrice = `${finalPrice.toFixed(2)} ‚Ç¨`;
                    }
                    
                    // Mettre √† jour l'affichage
                    priceElement.innerHTML = displayPrice;
                    
                    if (isVIPPrice) {
                        priceElement.innerHTML += ' <span class="vip-badge">VIP</span>';
                    }
                    
                    // Afficher le total pour les forfaits
                    if (currentState.packageQuantity > 1) {
                        totalPriceElement.textContent = displayTotalPrice;
                        totalPriceContainer.style.display = 'flex';
                    } else {
                        totalPriceContainer.style.display = 'none';
                    }
                    
                    console.log(`üí∞ Prix affich√©: ${displayPrice} (VIP: ${isVIPPrice})`);
                    
                } catch (error) {
                    console.error('‚ùå Erreur lors de l\'affichage du prix:', error);
                    priceElement.textContent = 'Erreur';
                }
            }
            
            function getDefaultPrice(courseType, duration) {
                // Prix par d√©faut si tout √©choue
                const basePrices = {
                    'essai': 0,
                    'conversation': 20,
                    'curriculum': 35,
                    'examen': 30
                };
                
                let price = basePrices[courseType] || 20;
                
                // Ajuster selon la dur√©e (sauf pour l'essai)
                if (courseType !== 'essai') {
                    const ratio = duration / 60;
                    price = price * ratio;
                }
                
                return price;
            }
            
            function updateSummary() {
                console.log('üìã Mise √† jour du r√©sum√©...');
                
                // Type de cours
                const courseTypeNames = {
                    'essai': 'Cours d\'essai',
                    'conversation': 'Conversation',
                    'curriculum': 'Curriculum Complet',
                    'examen': 'Pr√©paration d\'examen'
                };
                
                document.getElementById('summaryCourseType').textContent = 
                    courseTypeNames[currentState.courseType] || 'Cours de fran√ßais';
                
                // Dur√©e
                document.getElementById('summaryDuration').textContent = 
                    currentState.duration ? `${currentState.duration} minutes` : '-';
                
                // Date et heure
                const dateElement = document.getElementById('summaryDate');
                const timeElement = document.getElementById('summaryTime');
                
                if (currentState.selectedSlot) {
                    try {
                        const date = new Date(currentState.selectedSlot.start);
                        const formattedDate = date.toLocaleDateString('fr-FR', {
                            weekday: 'long',
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric'
                        });
                        const formattedTime = date.toLocaleTimeString('fr-FR', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        dateElement.textContent = formattedDate;
                        timeElement.textContent = formattedTime;
                    } catch (error) {
                        dateElement.textContent = 'Erreur de date';
                        timeElement.textContent = '-';
                    }
                } else {
                    dateElement.textContent = 'Non s√©lectionn√©e';
                    timeElement.textContent = '-';
                }
                
                // Mettre √† jour l'affichage du prix
                updatePriceDisplay();
                
                console.log('‚úÖ R√©sum√© mis √† jour');
            }
            
            async function loadAvailableSlots(date) {
                console.log(`üìÖ Chargement des cr√©neaux pour le ${date}...`);
                
                const loadingElement = document.getElementById('loadingSlots');
                const slotsGrid = document.getElementById('timeSlotsGrid');
                const noSlotsMessage = document.getElementById('noSlotsMessage');
                
                // Afficher le loader
                loadingElement.style.display = 'flex';
                slotsGrid.innerHTML = '';
                noSlotsMessage.style.display = 'none';
                
                // Mettre √† jour la date affich√©e
                currentState.selectedDate = date;
                updateDateDisplay(date);
                
                try {
                    // R√©cup√©rer les cr√©neaux via BookingManager
                    const slots = await window.bookingManager.getAvailableSlots(
                        currentState.courseType, 
                        date, 
                        currentState.duration
                    );
                    
                    // Cacher le loader
                    loadingElement.style.display = 'none';
                    
                    if (slots.length === 0) {
                        // Aucun cr√©neau disponible
                        noSlotsMessage.style.display = 'block';
                        return;
                    }
                    
                    // Afficher les cr√©neaux
                    slots.forEach(slot => {
                        const slotElement = createTimeSlotElement(slot);
                        slotsGrid.appendChild(slotElement);
                    });
                    
                    console.log(`‚úÖ ${slots.length} cr√©neau(x) affich√©(s)`);
                    
                } catch (error) {
                    console.error('‚ùå Erreur lors du chargement des cr√©neaux:', error);
                    loadingElement.style.display = 'none';
                    noSlotsMessage.style.display = 'block';
                    
                    // Afficher un message d'erreur
                    noSlotsMessage.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Erreur de chargement</h3>
                        <p>Impossible de charger les cr√©neaux: ${error.message}</p>
                    `;
                }
            }
            
            function createTimeSlotElement(slot) {
                const element = document.createElement('div');
                element.className = 'time-slot';
                element.setAttribute('data-slot-id', slot.id);
                element.setAttribute('data-start', slot.start);
                element.setAttribute('data-end', slot.end);
                
                // Formater l'heure
                const startTime = new Date(slot.start);
                const formattedTime = startTime.toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                element.innerHTML = `
                    <div class="time-slot-content">
                        <div class="time-display">
                            <i class="far fa-clock"></i>
                            <span class="time-value">${formattedTime}</span>
                        </div>
                        <div class="duration-display">
                            <span class="duration-value">${slot.duration}</span>
                        </div>
                    </div>
                `;
                
                // Ajouter l'√©couteur d'√©v√©nement
                element.addEventListener('click', () => selectTimeSlot(element, slot));
                
                // V√©rifier si ce cr√©neau est d√©j√† s√©lectionn√©
                if (currentState.selectedSlot && currentState.selectedSlot.id === slot.id) {
                    element.classList.add('selected');
                }
                
                return element;
            }
            
            function selectTimeSlot(element, slot) {
                console.log('üéØ Cr√©neau s√©lectionn√©:', slot);
                
                // Retirer la s√©lection pr√©c√©dente
                document.querySelectorAll('.time-slot.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // Ajouter la s√©lection
                element.classList.add('selected');
                
                // Mettre √† jour l'√©tat
                currentState.selectedSlot = slot;
                
                // Mettre √† jour l'interface
                updateUserInterface();
                updateSummary();
                
                // Activer le bouton de r√©servation
                const bookButton = document.getElementById('bookButton');
                if (bookButton) {
                    bookButton.disabled = false;
                }
            }
            
            function updateDateDisplay(dateString) {
                const date = new Date(dateString);
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                let displayText = '';
                
                // V√©rifier si c'est aujourd'hui, demain, ou une autre date
                if (date.toDateString() === today.toDateString()) {
                    displayText = `Aujourd'hui, ${date.toLocaleDateString('fr-FR', { 
                        day: 'numeric', 
                        month: 'long',
                        year: 'numeric'
                    })}`;
                } else if (date.toDateString() === tomorrow.toDateString()) {
                    displayText = `Demain, ${date.toLocaleDateString('fr-FR', { 
                        day: 'numeric', 
                        month: 'long',
                        year: 'numeric'
                    })}`;
                } else {
                    displayText = date.toLocaleDateString('fr-FR', { 
                        weekday: 'long',
                        day: 'numeric', 
                        month: 'long',
                        year: 'numeric'
                    });
                }
                
                document.getElementById('currentDate').textContent = displayText;
            }
            
            function navigateDate(days) {
                const currentDate = currentState.selectedDate ? 
                    new Date(currentState.selectedDate) : 
                    new Date();
                
                currentDate.setDate(currentDate.getDate() + days);
                const newDateString = currentDate.toISOString().split('T')[0];
                
                // Recharger les cr√©neaux pour la nouvelle date
                loadAvailableSlots(newDateString);
            }
            
            function getTodayDateString() {
                const today = new Date();
                return today.toISOString().split('T')[0];
            }
            
            function goToStep(stepNumber) {
                console.log(`‚û°Ô∏è Passage √† l'√©tape ${stepNumber}`);
                
                // Mettre √† jour les indicateurs de progression
                document.querySelectorAll('.progress-step').forEach((step, index) => {
                    if (index + 1 <= stepNumber) {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                    }
                });
                
                // G√©rer l'affichage selon l'√©tape
                const bookingActions = document.getElementById('bookingActions');
                const userInfoForm = document.getElementById('userInfoForm');
                
                if (stepNumber === 1) {
                    bookingActions.style.display = 'block';
                    userInfoForm.style.display = 'none';
                } else if (stepNumber === 2) {
                    bookingActions.style.display = 'none';
                    userInfoForm.style.display = 'block';
                    
                    // Pr√©-remplir les informations utilisateur si connect√©
                    if (currentState.user) {
                        document.getElementById('userName').value = 
                            currentState.user.profile?.full_name || 
                            currentState.user.user_metadata?.full_name || 
                            '';
                        document.getElementById('userEmail').value = 
                            currentState.user.email || '';
                    }
                }
            }
            
            async function proceedToBooking() {
                console.log('üöÄ D√©but du processus de r√©servation...');
                
                // V√©rifier qu'un cr√©neau est s√©lectionn√©
                if (!currentState.selectedSlot) {
                    alert('Veuillez s√©lectionner un cr√©neau horaire.');
                    return;
                }
                
                // V√©rifier que l'utilisateur est connect√©
                if (!currentState.user) {
                    alert('Veuillez vous connecter pour r√©server un cours.');
                    return;
                }
                
                // Passer √† l'√©tape 2 (informations personnelles)
                goToStep(2);
            }
            
            async function proceedToPayment() {
                console.log('üí≥ Passage au paiement...');
                
                // Valider les informations
                const userName = document.getElementById('userName').value.trim();
                const userEmail = document.getElementById('userEmail').value.trim();
                
                if (!userName || !userEmail) {
                    alert('Veuillez remplir votre nom et votre adresse email.');
                    return;
                }
                
                // Pr√©parer les donn√©es de r√©servation
                const bookingData = {
                    startTime: currentState.selectedSlot.start,
                    endTime: currentState.selectedSlot.end,
                    eventType: currentState.courseType,
                    courseType: currentState.courseType,
                    duration: currentState.duration,
                    name: userName,
                    email: userEmail,
                    notes: document.getElementById('userNotes').value.trim(),
                    location: 'integrations:zoom',
                    packageQuantity: currentState.packageQuantity
                };
                
                // Ajouter l'ID de l'event type Cal.com
                bookingData.eventTypeId = window.bookingManager?.eventTypeMap[currentState.courseType];
                
                console.log('üì¶ Donn√©es de r√©servation:', bookingData);
                
                try {
                    // Utiliser BookingManager pour cr√©er la r√©servation
                    const result = await window.bookingManager.createBooking(bookingData);
                    
                    if (result.success) {
                        console.log('‚úÖ R√©servation pr√©par√©e, redirection vers le paiement');
                        
                        // Passer √† l'√©tape 3
                        goToStep(3);
                        
                        // Rediriger vers la page de paiement
                        setTimeout(() => {
                            window.location.href = result.redirectTo;
                        }, 500);
                    } else {
                        console.error('‚ùå Erreur lors de la cr√©ation de la r√©servation:', result.error);
                        alert(`Erreur: ${result.error}`);
                    }
                } catch (error) {
                    console.error('‚ùå Exception lors de la r√©servation:', error);
                    alert(`Une erreur est survenue: ${error.message}`);
                }
            }
            
            // Initialiser la date d'aujourd'hui
            function selectToday() {
                const today = getTodayDateString();
                loadAvailableSlots(today);
            }
            
            // Initialisation automatique
            selectToday();
            
            // Debug functions
            window.debugBookingState = function() {
                console.group('üîç √âtat de booking.html');
                console.log('currentState:', currentState);
                console.log('Utilisateur:', currentState.user);
                console.log('Est VIP:', currentState.isVIP);
                console.log('Type de cours:', currentState.courseType);
                console.log('Dur√©e:', currentState.duration);
                console.log('Cr√©neau s√©lectionn√©:', currentState.selectedSlot);
                console.log('Quantit√© forfait:', currentState.packageQuantity);
                console.groupEnd();
            };
            
            window.testVipPriceInBooking = async function() {
                console.group('üß™ Test prix VIP dans booking.html');
                
                if (!currentState.user) {
                    console.error('‚ùå Utilisateur non connect√©');
                    console.groupEnd();
                    return;
                }
                
                console.log('Utilisateur:', currentState.user.email);
                console.log('Est VIP?', currentState.isVIP);
                
                const vipPrice = await window.authManager.getVipPrice(currentState.courseType, currentState.duration);
                console.log('Prix VIP retourn√©:', vipPrice);
                
                if (vipPrice) {
                    console.log(`üí∞ Prix: ${vipPrice.price} ${vipPrice.currency}`);
                    console.log(`‚è±Ô∏è Dur√©e: ${vipPrice.duration} min`);
                }
                
                console.groupEnd();
            };
        });
    </script>
</body>
</html>