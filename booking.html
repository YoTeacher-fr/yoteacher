<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©server un cours - YoTeacher</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üá´üá∑</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* R√âDUCTION DE LA HAUTEUR DU HEADER */
        .main-header {
            background-color: rgba(255, 255, 255, 0.98) !important;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1) !important;
            backdrop-filter: blur(10px) !important;
            min-height: 60px !important;
        }
        
        .header-content {
            padding: 10px 0 !important;
        }
        
        .main-header .nav-link {
            display: none !important;
        }
        
        .main-header .nav-spacer {
            display: none !important;
        }
        
        .main-header .logo {
            color: #333 !important;
            font-weight: 700;
            font-size: 1.5rem !important;
        }
        
        .main-header .login-btn {
            background-color: #4f9ad1 !important;
            color: white !important;
            padding: 8px 20px !important;
            font-size: 0.9rem !important;
        }
        
        /* CORRECTION DU PADDING DU BODY */
        body {
            padding-top: 60px !important;
        }
        
        /* FOND INITIAL DE BOOKING */
        .booking-section {
            padding: 40px 20px;
            background: #f8f9fa;
            min-height: calc(100vh - 60px);
        }

        .booking-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .booking-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .booking-title {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 15px;
        }

        .booking-subtitle {
            color: #666;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .booking-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .booking-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid #eaeaea;
        }

        .card-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .calendar-container {
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .month-year {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .calendar-nav button:hover {
            background: #f0f0f0;
            border-color: #3c84f6;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .calendar-day-header {
            text-align: center;
            padding: 10px;
            font-weight: 600;
            color: #666;
            font-size: 0.9rem;
        }

        .calendar-day {
            text-align: center;
            padding: 12px 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .calendar-day:hover {
            background: #f0f7ff;
        }

        .calendar-day.selected {
            background: #3c84f6;
            color: white;
        }

        .calendar-day.disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .calendar-day.today {
            border: 2px solid #3c84f6;
        }

        .time-slots {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .time-slot {
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-slot:hover {
            border-color: #3c84f6;
            background: #f0f7ff;
        }

        .time-slot.selected {
            background: #3c84f6;
            color: white;
            border-color: #3c84f6;
        }

        .time-slot.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .time-slot-time {
            font-weight: 600;
        }

        .time-slot-duration {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3c84f6;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* NOUVEAUX STYLES */
        .quantity-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .quantity-option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quantity-option:hover {
            border-color: #3c84f6;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(60, 132, 246, 0.1);
        }

        .quantity-option.selected {
            background: #3c84f6;
            border-color: #3c84f6;
            color: white;
        }

        .quantity-number {
            font-size: 1.8rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 5px;
        }

        .quantity-label {
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 5px;
        }

        .quantity-price {
            font-size: 0.85rem;
            font-weight: 600;
            color: #4CAF50;
        }

        .quantity-option.selected .quantity-price {
            color: rgba(255, 255, 255, 0.9);
        }

        .package-info {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2e7d32;
            margin-top: 10px;
        }

        .package-info i {
            font-size: 1.2rem;
        }

        .use-credits-section {
            background: #f0f7ff;
            border: 2px solid #3c84f6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .use-credits-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .use-credits-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
        }

        .use-credits-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .currency-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .currency-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .currency-btn:hover {
            border-color: #3c84f6;
            background: #f0f7ff;
        }

        .booking-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .summary-item.total {
            font-weight: 600;
            font-size: 1.2rem;
            border-bottom: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #ddd;
        }

        .btn-booking {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3c84f6, #1e88e5);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-booking:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(60, 132, 246, 0.3);
        }

        .btn-booking:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #ffeaea;
            color: #d32f2f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #d32f2f;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #2e7d32;
        }

        .loading-slots {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-slots {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .error-slots {
            text-align: center;
            padding: 30px;
            background: #ffeaea;
            border-radius: 10px;
            color: #d32f2f;
        }

        .login-required {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .booking-section {
                padding: 30px 15px;
            }
            
            .booking-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }
            
            .booking-title {
                font-size: 2rem;
            }
            
            .calendar-grid {
                gap: 3px;
            }
            
            .calendar-day {
                padding: 8px 3px;
                font-size: 0.9rem;
            }
            
            .booking-card {
                padding: 25px 20px;
            }
            
            .quantity-selector {
                grid-template-columns: 1fr;
            }
            
            .currency-selector {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 20px;
            }
            
            .currency-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header r√©duit -->
    <header class="main-header scrolled">
        <div class="container">
            <div class="header-content">
                <button class="hamburger-menu" id="hamburgerBtn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                
                <div class="logo-section">
                    <a href="index.html" class="logo">Yoann</a>
                    <div class="flag">üá´üá∑</div>
                </div>
                
                <a href="login.html" class="mobile-login-btn-header">Connexion</a>
                
                <nav class="nav-menu desktop-menu">
                    <div class="language-switcher">
                        <span class="flag">üåê</span>
                        <span>FR</span>
                    </div>
                    
                    <a href="login.html" class="login-btn">Connexion</a>
                </nav>
            </div>
        </div>
    </header>

    <section class="booking-section">
        <div class="booking-container">
            <div class="booking-header">
                <h1 class="booking-title">R√©server un cours</h1>
                <p class="booking-subtitle">Choisissez la date, l'heure et le type de cours qui vous convient</p>
            </div>

            <!-- S√©lecteur de devise -->
            <div class="currency-selector">
                <button class="currency-btn" id="currencyToggle">
                    <span id="currentCurrencyFlag">üá™üá∫</span>
                    <span id="currentCurrencyCode">EUR</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="currency-dropdown" id="currencyDropdown" style="display: none;">
                    <div class="currency-search">
                        <input type="text" placeholder="Rechercher..." id="currencySearch">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="currency-list" id="currencyList"></div>
                </div>
            </div>

            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
            </div>

            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i> <span id="successText"></span>
            </div>

            <div class="booking-grid">
                <!-- Colonne gauche : Calendrier et cr√©neaux -->
                <div class="booking-card">
                    <h2 class="card-title">Choisir un cr√©neau</h2>
                    
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="month-year" id="currentMonth">Janvier 2024</div>
                            <div class="calendar-nav">
                                <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                                <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        
                        <div class="calendar-grid" id="calendarDays"></div>
                    </div>

                    <h3 style="margin-bottom: 15px;">Cr√©neaux disponibles</h3>
                    <div class="time-slots" id="timeSlots"></div>
                </div>

                <!-- Colonne droite : Formulaire et r√©capitulatif -->
                <div class="booking-card">
                    <h2 class="card-title">D√©tails de la r√©servation</h2>
                    
                    <!-- Section utiliser cr√©dits -->
                    <div class="use-credits-section" id="useCreditsSection">
                        <h3><i class="fas fa-ticket-alt"></i> Utiliser mes cr√©dits</h3>
                        <p>Vous avez <strong id="availableCredits">0</strong> cr√©dit(s) disponible(s)</p>
                        <button class="use-credits-btn" id="useCreditsBtn">
                            <i class="fas fa-ticket-alt"></i> R√©server avec cr√©dits
                        </button>
                        <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                            <i class="fas fa-info-circle"></i> Cette r√©servation utilisera 1 cr√©dit
                        </p>
                    </div>

                    <!-- Message de connexion requise -->
                    <div class="login-required" id="loginRequired" style="display: none;">
                        <i class="fas fa-info-circle"></i> Pour r√©server un cours <span id="courseTypeName"></span>, 
                        <a href="login.html" id="loginLink">connectez-vous</a> ou 
                        <a href="signup.html" id="signupLink">cr√©ez un compte</a>.
                    </div>
                    
                    <form id="bookingForm">
                        <div class="form-group">
                            <label class="form-label" for="courseType">Type de cours</label>
                            <select id="courseType" class="form-select" required>
                                <option value="">S√©lectionnez un type de cours</option>
                                <option value="essai">Cours d'essai</option>
                                <option value="conversation">Conversation</option>
                                <option value="curriculum">Curriculum complet</option>
                            </select>
                        </div>

                        <!-- S√©lecteur de quantit√© -->
                        <div class="form-group">
                            <label class="form-label">Nombre de cours</label>
                            <div class="quantity-selector">
                                <button type="button" class="quantity-option selected" data-quantity="1">
                                    <span class="quantity-number">1</span>
                                    <span class="quantity-label">Cours unique</span>
                                    <span class="quantity-price" id="price1">5‚Ç¨</span>
                                </button>
                                <button type="button" class="quantity-option" data-quantity="5">
                                    <span class="quantity-number">5</span>
                                    <span class="quantity-label">Forfait 5</span>
                                    <span class="quantity-price" id="price5">-10%</span>
                                </button>
                                <button type="button" class="quantity-option" data-quantity="10">
                                    <span class="quantity-number">10</span>
                                    <span class="quantity-label">Forfait 10</span>
                                    <span class="quantity-price" id="price10">-15%</span>
                                </button>
                            </div>
                            <input type="hidden" id="courseQuantity" value="1">
                        </div>

                        <!-- S√©lecteur de dur√©e -->
                        <div class="form-group duration-group" id="durationGroup" style="display: none;">
                            <label class="form-label">Dur√©e du cours</label>
                            <div class="duration-options">
                                <button type="button" class="duration-option" data-duration="30">30 min</button>
                                <button type="button" class="duration-option" data-duration="45">45 min</button>
                                <button type="button" class="duration-option selected" data-duration="60">60 min</button>
                            </div>
                            <input type="hidden" id="duration" value="60">
                        </div>

                        <!-- Info forfait -->
                        <div class="package-info" id="packageInfo" style="display: none;">
                            <i class="fas fa-gift"></i>
                            <span>Ce forfait vous donne <strong id="creditsCount">5</strong> cr√©dits utilisables pour r√©server des cours.</span>
                        </div>

                        <!-- Outil de r√©union -->
                        <div class="form-group">
                            <label class="form-label" for="meetingTool">Outil de visioconf√©rence</label>
                            <select id="meetingTool" class="form-select">
                                <option value="cal_video">Cal.com Video (par d√©faut)</option>
                                <option value="zoom">Zoom</option>
                                <option value="google_meet">Google Meet</option>
                                <option value="microsoft_teams">Microsoft Teams</option>
                                <option value="whereby">Whereby</option>
                                <option value="jitsi">Jitsi</option>
                                <option value="phone">T√©l√©phone</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="name">Nom complet</label>
                            <input type="text" id="name" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="email">Email</label>
                            <input type="email" id="email" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="notes">Notes pour le professeur (optionnel)</label>
                            <textarea id="notes" class="form-textarea" placeholder="Votre niveau, objectifs, sujets de discussion pr√©f√©r√©s..."></textarea>
                        </div>

                        <div class="booking-summary">
                            <h3 style="margin-bottom: 15px;">R√©capitulatif</h3>
                            <div class="summary-item">
                                <span>Type de cours:</span>
                                <span id="summaryType">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Date:</span>
                                <span id="summaryDate">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Heure:</span>
                                <span id="summaryTime">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Dur√©e:</span>
                                <span id="summaryDuration">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Nombre de cours:</span>
                                <span id="summaryQuantity">1</span>
                            </div>
                            <div class="summary-item">
                                <span>Outil:</span>
                                <span id="summaryTool">Cal.com Video</span>
                            </div>
                            <div class="summary-item total">
                                <span>Total:</span>
                                <span id="summaryPrice">-</span>
                            </div>
                        </div>

                        <button type="submit" class="btn-booking" id="submitBooking" disabled>
                            <i class="fas fa-calendar-check"></i> R√©server et payer
                        </button>
                        
                        <div style="margin-top: 15px; text-align: center; font-size: 0.9rem; color: #666;">
                            <i class="fas fa-lock"></i> Vous serez redirig√© vers la page de paiement apr√®s confirmation
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script src="auth.js"></script>
    <script src="booking.js"></script>
    <script src="mobile-menu.js"></script>
    <script src="common.js"></script>
    <script src="currency.js"></script>
    <script src="packages.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables globales
        let selectedDate = null;
        let selectedTime = null;
        let selectedSlot = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentCurrency = 'EUR';
        let availableCredits = 0;

        // Initialisation
        initializePage();

        // Fonctions d'initialisation
        async function initializePage() {
            setupEventListeners();
            initCalendar();
            updateCurrencyDisplay();
            checkUserCredits();
            loadUserPreferences();
            
            // S√©lectionner aujourd'hui par d√©faut
            const today = new Date().toISOString().split('T')[0];
            selectToday(today);
            
            // Mettre √† jour les prix
            updatePrices();
        }

        function setupEventListeners() {
            // Navigation calendrier
            document.getElementById('prevMonth').addEventListener('click', prevMonth);
            document.getElementById('nextMonth').addEventListener('click', nextMonth);
            
            // Type de cours
            document.getElementById('courseType').addEventListener('change', handleCourseTypeChange);
            
            // Quantit√©
            document.querySelectorAll('.quantity-option').forEach(btn => {
                btn.addEventListener('click', handleQuantityChange);
            });
            
            // Dur√©e
            document.querySelectorAll('.duration-option').forEach(btn => {
                btn.addEventListener('click', handleDurationChange);
            });
            
            // Devise
            document.getElementById('currencyToggle').addEventListener('click', toggleCurrencyDropdown);
            
            // Formulaire
            document.getElementById('bookingForm').addEventListener('submit', handleFormSubmit);
            
            // Utiliser cr√©dits
            document.getElementById('useCreditsBtn').addEventListener('click', handleUseCredits);
            
            // √âcouter les √©v√©nements
            window.addEventListener('auth:login', handleAuthChange);
            window.addEventListener('auth:logout', handleAuthChange);
            window.addEventListener('currencyChanged', handleCurrencyChange);
        }

        // Gestion du calendrier
        function initCalendar() {
            const monthNames = [
                'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
            ];
            
            document.getElementById('currentMonth').textContent = 
                `${monthNames[currentMonth]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            const dayHeaders = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            // En-t√™tes
            dayHeaders.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day-header';
                dayElement.textContent = day;
                calendarDays.appendChild(dayElement);
            });
            
            // Jours vides
            for (let i = 0; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day disabled';
                calendarDays.appendChild(emptyDay);
            }
            
            // Jours du mois
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                dayElement.setAttribute('data-date', 
                    `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`
                );
                
                if (date.getDate() === today.getDate() && 
                    date.getMonth() === today.getMonth() && 
                    date.getFullYear() === today.getFullYear()) {
                    dayElement.classList.add('today');
                }
                
                if (date < today) {
                    dayElement.classList.add('disabled');
                } else {
                    dayElement.addEventListener('click', () => selectDate(
                        `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`
                    ));
                }
                
                calendarDays.appendChild(dayElement);
            }
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            initCalendar();
            if (selectedDate) {
                loadAvailableSlots(selectedDate);
            }
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            initCalendar();
            if (selectedDate) {
                loadAvailableSlots(selectedDate);
            }
        }

        function selectToday(today) {
            const todayElement = document.querySelector(`.calendar-day[data-date="${today}"]`);
            if (todayElement && !todayElement.classList.contains('disabled')) {
                selectDate(today);
            } else {
                const firstAvailable = document.querySelector('.calendar-day:not(.disabled)');
                if (firstAvailable) {
                    selectDate(firstAvailable.getAttribute('data-date'));
                }
            }
        }

        function selectDate(date) {
            selectedDate = date;
            
            document.querySelectorAll('.calendar-day').forEach(dayEl => {
                dayEl.classList.remove('selected');
            });
            
            const selectedDayElement = document.querySelector(`.calendar-day[data-date="${date}"]`);
            if (selectedDayElement) {
                selectedDayElement.classList.add('selected');
            }
            
            loadAvailableSlots(selectedDate);
            updateSummary();
        }

        async function loadAvailableSlots(date) {
            try {
                const timeSlots = document.getElementById('timeSlots');
                timeSlots.innerHTML = '<div class="loading-slots"><i class="fas fa-spinner fa-spin"></i> Chargement des cr√©neaux...</div>';
                
                const courseType = document.getElementById('courseType').value || 'essai';
                const duration = parseInt(document.getElementById('duration').value) || 60;
                
                const slots = await window.bookingManager.getAvailableSlots(courseType, date, duration);
                
                timeSlots.innerHTML = '';
                
                if (slots.length === 0) {
                    timeSlots.innerHTML = '<p class="no-slots">Aucun cr√©neau disponible pour cette date.</p>';
                    return;
                }
                
                let hasFutureSlots = false;
                
                slots.forEach(slot => {
                    const slotDate = new Date(slot.start);
                    const now = new Date();
                    
                    if (slotDate > now) {
                        hasFutureSlots = true;
                        const slotElement = document.createElement('div');
                        slotElement.className = 'time-slot';
                        slotElement.innerHTML = `
                            <div class="time-slot-time">
                                <i class="far fa-clock"></i>
                                ${slotDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                            <div class="time-slot-duration">
                                ${slot.duration}
                            </div>
                        `;
                        
                        slotElement.addEventListener('click', () => selectTimeSlot(slot, slotElement));
                        timeSlots.appendChild(slotElement);
                    }
                });
                
                if (!hasFutureSlots) {
                    timeSlots.innerHTML = '<p class="no-slots">Tous les cr√©neaux sont complets pour aujourd\'hui.</p>';
                }
            } catch (error) {
                console.error('Erreur chargement cr√©neaux:', error);
                timeSlots.innerHTML = `
                    <div class="error-slots">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erreur lors du chargement des cr√©neaux</p>
                        <p class="error-details">${error.message || 'Veuillez r√©essayer'}</p>
                        <button onclick="loadAvailableSlots('${date}')" class="retry-btn">
                            <i class="fas fa-redo"></i> R√©essayer
                        </button>
                    </div>
                `;
            }
        }

        function selectTimeSlot(slot, element) {
            document.querySelectorAll('.time-slot').forEach(slotEl => {
                slotEl.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedSlot = slot;
            selectedTime = new Date(slot.start).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            if (slot.durationInMinutes) {
                const durationButton = document.querySelector(`.duration-option[data-duration="${slot.durationInMinutes}"]`);
                if (durationButton) {
                    document.querySelectorAll('.duration-option').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    durationButton.classList.add('selected');
                    document.getElementById('duration').value = slot.durationInMinutes;
                }
            }
            
            updateSummary();
        }

        // Gestion des changements
        function handleCourseTypeChange() {
            const courseType = this.value;
            updateUIForCourseType(courseType);
            updatePrices();
            
            if (selectedDate) {
                loadAvailableSlots(selectedDate);
            }
            
            updateSummary();
        }

        function handleQuantityChange() {
            const quantity = parseInt(this.getAttribute('data-quantity'));
            
            document.querySelectorAll('.quantity-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            this.classList.add('selected');
            
            document.getElementById('courseQuantity').value = quantity;
            
            // Afficher/masquer info forfait
            const packageInfo = document.getElementById('packageInfo');
            if (quantity > 1) {
                packageInfo.style.display = 'flex';
                document.getElementById('creditsCount').textContent = quantity;
            } else {
                packageInfo.style.display = 'none';
            }
            
            updatePrices();
            updateSummary();
        }

        function handleDurationChange() {
            const duration = parseInt(this.getAttribute('data-duration'));
            
            document.querySelectorAll('.duration-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            this.classList.add('selected');
            
            document.getElementById('duration').value = duration;
            
            if (selectedDate) {
                loadAvailableSlots(selectedDate);
            }
            
            updatePrices();
            updateSummary();
        }

        function handleCurrencyChange() {
            updateCurrencyDisplay();
            updatePrices();
            updateSummary();
        }

        function handleAuthChange() {
            checkUserCredits();
            updateUIForCourseType(document.getElementById('courseType').value);
        }

        // Mise √† jour de l'interface
        function updateUIForCourseType(courseType) {
            const user = window.authManager?.getCurrentUser();
            const isLoggedIn = !!user;
            
            // G√©rer connexion requise
            if (courseType === 'essai') {
                document.getElementById('loginRequired').style.display = 'none';
                document.getElementById('useCreditsSection').style.display = 'none';
                document.getElementById('durationGroup').style.display = 'none';
            } else {
                if (isLoggedIn) {
                    document.getElementById('loginRequired').style.display = 'none';
                    document.getElementById('useCreditsSection').style.display = 'block';
                    document.getElementById('durationGroup').style.display = 'block';
                } else {
                    document.getElementById('loginRequired').style.display = 'block';
                    document.getElementById('useCreditsSection').style.display = 'none';
                    document.getElementById('durationGroup').style.display = 'none';
                }
            }
            
            // Pr√©-remplir les informations
            if (isLoggedIn && user) {
                document.getElementById('name').value = user.user_metadata?.full_name || user.email?.split('@')[0] || '';
                document.getElementById('email').value = user.email || '';
            }
        }

        // Mise √† jour des prix
        function updatePrices() {
            if (!window.currencyManager || !window.packagesManager) return;
            
            const courseType = document.getElementById('courseType').value;
            const quantity = parseInt(document.getElementById('courseQuantity').value);
            const duration = parseInt(document.getElementById('duration').value) || 60;
            
            // Mettre √† jour les boutons de quantit√©
            document.querySelectorAll('.quantity-option').forEach(btn => {
                const btnQuantity = parseInt(btn.getAttribute('data-quantity'));
                const price = window.packagesManager.calculatePrice(courseType, btnQuantity, duration);
                const formattedPrice = window.currencyManager.format(price);
                
                const priceElement = btn.querySelector('.quantity-price');
                if (priceElement) {
                    if (btnQuantity === 1) {
                        priceElement.id = 'price1';
                    } else if (btnQuantity === 5) {
                        priceElement.id = 'price5';
                    } else if (btnQuantity === 10) {
                        priceElement.id = 'price10';
                    }
                    priceElement.textContent = formattedPrice;
                }
            });
        }

        // Mise √† jour du r√©capitulatif
        function updateSummary() {
            const courseType = document.getElementById('courseType').value;
            const quantity = parseInt(document.getElementById('courseQuantity').value);
            const duration = parseInt(document.getElementById('duration').value) || 60;
            const meetingTool = document.getElementById('meetingTool').value;
            
            let courseName = '-';
            let price = 0;
            
            if (courseType === 'essai') {
                courseName = 'Cours d\'essai';
                price = 5;
            } else if (courseType === 'conversation') {
                courseName = 'Conversation';
                price = window.packagesManager.calculatePrice(courseType, quantity, duration);
            } else if (courseType === 'curriculum') {
                courseName = 'Curriculum complet';
                price = window.packagesManager.calculatePrice(courseType, quantity, duration);
            }
            
            // Formater le prix avec la devise actuelle
            const formattedPrice = window.currencyManager ? 
                window.currencyManager.format(price) : `${price}‚Ç¨`;
            
            // Mettre √† jour l'affichage
            document.getElementById('summaryType').textContent = courseName;
            document.getElementById('summaryDate').textContent = selectedDate ? 
                new Date(selectedDate).toLocaleDateString('fr-FR') : '-';
            document.getElementById('summaryTime').textContent = selectedTime || '-';
            document.getElementById('summaryDuration').textContent = duration + ' min';
            document.getElementById('summaryQuantity').textContent = quantity;
            document.getElementById('summaryTool').textContent = 
                document.getElementById('meetingTool').options[document.getElementById('meetingTool').selectedIndex].text;
            document.getElementById('summaryPrice').textContent = formattedPrice;
            
            // Activer/d√©sactiver le bouton de soumission
            const user = window.authManager?.getCurrentUser();
            const canSubmit = selectedDate && selectedTime && courseType && 
                (courseType === 'essai' || (user && duration));
            
            document.getElementById('submitBooking').disabled = !canSubmit;
        }

        // Gestion de la devise
        function updateCurrencyDisplay() {
            if (!window.currencyManager) return;
            
            currentCurrency = window.currencyManager.getCurrentCurrency();
            const currency = window.currencyManager.getAvailableCurrencies()
                .find(c => c.code === currentCurrency);
            
            if (currency) {
                document.getElementById('currentCurrencyFlag').textContent = currency.country;
                document.getElementById('currentCurrencyCode').textContent = currency.code;
            }
        }

        function toggleCurrencyDropdown() {
            const dropdown = document.getElementById('currencyDropdown');
            const isVisible = dropdown.style.display === 'block';
            
            // Fermer tous les autres dropdowns
            document.querySelectorAll('.currency-dropdown').forEach(d => {
                d.style.display = 'none';
            });
            
            if (!isVisible) {
                dropdown.style.display = 'block';
                populateCurrencyList();
            }
        }

        function populateCurrencyList() {
            if (!window.currencyManager) return;
            
            const currencyList = document.getElementById('currencyList');
            const currencies = window.currencyManager.getAvailableCurrencies();
            
            currencyList.innerHTML = currencies.map(currency => `
                <div class="currency-item" data-code="${currency.code}">
                    <span class="currency-flag">${currency.country}</span>
                    <span class="currency-name">${currency.name}</span>
                    <span class="currency-code">${currency.code}</span>
                </div>
            `).join('');
            
            // Recherche
            document.getElementById('currencySearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.currency-item').forEach(item => {
                    const name = item.querySelector('.currency-name').textContent.toLowerCase();
                    const code = item.querySelector('.currency-code').textContent.toLowerCase();
                    item.style.display = name.includes(searchTerm) || code.includes(searchTerm) ? 'flex' : 'none';
                });
            });
            
            // S√©lection
            currencyList.addEventListener('click', function(e) {
                const item = e.target.closest('.currency-item');
                if (item) {
                    const currencyCode = item.dataset.code;
                    window.currencyManager.setCurrency(currencyCode);
                    document.getElementById('currencyDropdown').style.display = 'none';
                }
            });
            
            // Fermer en cliquant ailleurs
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.currency-selector')) {
                    document.getElementById('currencyDropdown').style.display = 'none';
                }
            });
        }

        // Gestion des cr√©dits utilisateur
        async function checkUserCredits() {
            const user = window.authManager?.getCurrentUser();
            if (!user) {
                document.getElementById('useCreditsSection').style.display = 'none';
                return;
            }
            
            try {
                if (window.packagesManager) {
                    availableCredits = await window.packagesManager.getUserCredits(user.id);
                    document.getElementById('availableCredits').textContent = availableCredits;
                    
                    // Afficher/masquer la section cr√©dits
                    if (availableCredits > 0) {
                        document.getElementById('useCreditsSection').style.display = 'block';
                    } else {
                        document.getElementById('useCreditsSection').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Erreur v√©rification cr√©dits:', error);
            }
        }

        // Soumission du formulaire
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!selectedDate || !selectedTime) {
                showError('Veuillez s√©lectionner une date et une heure');
                return;
            }
            
            const bookingData = collectBookingData();
            
            // Validation
            if (!bookingData.courseType || !bookingData.name || !bookingData.email) {
                showError('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            // D√©sactiver le bouton
            const submitBtn = document.getElementById('submitBooking');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Pr√©paration...';
            
            try {
                // Cr√©er la r√©servation
                const result = await window.bookingManager.createBooking(bookingData);
                
                if (result.success) {
                    showSuccess('Redirection vers le paiement...');
                    setTimeout(() => {
                        window.location.href = result.redirectTo;
                    }, 1000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showError('Erreur lors de la r√©servation : ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-calendar-check"></i> R√©server et payer';
            }
        }

        // Utiliser des cr√©dits
        async function handleUseCredits() {
            if (!selectedDate || !selectedTime) {
                showError('Veuillez s√©lectionner une date et une heure');
                return;
            }
            
            const user = window.authManager?.getCurrentUser();
            if (!user) {
                showError('Veuillez vous connecter pour utiliser vos cr√©dits');
                return;
            }
            
            const quantity = parseInt(document.getElementById('courseQuantity').value);
            
            if (availableCredits < quantity) {
                showError(`Cr√©dits insuffisants. Vous avez ${availableCredits} cr√©dit(s), besoin de ${quantity}`);
                return;
            }
            
            const bookingData = collectBookingData();
            bookingData.useCredits = true;
            
            // D√©sactiver le bouton
            const creditsBtn = document.getElementById('useCreditsBtn');
            creditsBtn.disabled = true;
            creditsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';
            
            try {
                const result = await window.bookingManager.createBookingWithCredits(bookingData);
                
                if (result.success) {
                    showSuccess('R√©servation confirm√©e avec vos cr√©dits !');
                    setTimeout(() => {
                        window.location.href = `booking-success.html?booking=${encodeURIComponent(JSON.stringify(bookingData))}`;
                    }, 1500);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showError('Erreur lors de la r√©servation : ' + error.message);
                creditsBtn.disabled = false;
                creditsBtn.innerHTML = '<i class="fas fa-ticket-alt"></i> R√©server avec cr√©dits';
            }
        }

        // Collecter les donn√©es du formulaire
        function collectBookingData() {
            const courseType = document.getElementById('courseType').value;
            const quantity = parseInt(document.getElementById('courseQuantity').value);
            const duration = parseInt(document.getElementById('duration').value) || 60;
            const price = window.packagesManager.calculatePrice(courseType, quantity, duration);
            
            return {
                eventType: courseType,
                startTime: selectedSlot.start,
                endTime: selectedSlot.end,
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                notes: document.getElementById('notes').value,
                courseType: courseType,
                price: price,
                duration: duration,
                quantity: quantity,
                meetingTool: document.getElementById('meetingTool').value,
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: 'fr'
            };
        }

        // Charger les pr√©f√©rences utilisateur
        async function loadUserPreferences() {
            const user = window.authManager?.getCurrentUser();
            if (!user || !window.supabase) return;
            
            try {
                const { data, error } = await window.supabase
                    .from('user_preferences')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                if (!error && data) {
                    if (data.preferred_currency) {
                        window.currencyManager.setCurrency(data.preferred_currency);
                    }
                    if (data.meeting_tool) {
                        document.getElementById('meetingTool').value = data.meeting_tool;
                    }
                }
            } catch (error) {
                console.error('Erreur chargement pr√©f√©rences:', error);
            }
        }

        // Messages
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            successText.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }
    });
    </script>
    
    <style>
    /* Styles pour le s√©lecteur de devise */
    .currency-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        width: 300px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        margin-top: 10px;
        overflow: hidden;
        z-index: 1000;
    }
    
    .currency-search {
        padding: 15px;
        border-bottom: 1px solid #eee;
        position: relative;
    }
    
    .currency-search input {
        width: 100%;
        padding: 10px 15px 10px 35px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.95rem;
    }
    
    .currency-search i {
        position: absolute;
        left: 25px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
    }
    
    .currency-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .currency-item {
        padding: 12px 15px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f5f5f5;
        transition: background 0.2s;
    }
    
    .currency-item:hover {
        background: #f8f9fa;
    }
    
    .currency-item:last-child {
        border-bottom: none;
    }
    
    .currency-name {
        flex: 1;
        font-weight: 500;
    }
    
    @media (max-width: 768px) {
        .currency-dropdown {
            width: calc(100vw - 40px);
            right: -10px;
        }
    }
    </style>
</body>
</html>