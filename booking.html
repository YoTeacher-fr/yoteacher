<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©server un cours - YoTeacher</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üá´üá∑</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
       /* MODIFICATIONS CSS √Ä AJOUTER/REMPLACER dans le <style> de booking.html */

/* HEADER - M√äME POSITION QUE LOGIN */
.main-header {
    background-color: rgba(255, 255, 255, 0.98) !important;
    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1) !important;
    backdrop-filter: blur(10px) !important;
    min-height: 60px !important;
}

.header-content {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 10px 0 !important;
}

/* Logo √† gauche */
.logo-section {
    display: flex;
    align-items: center;
    gap: 10px;
    order: 1;
}

.main-header .logo {
    color: #333 !important;
    font-weight: 700;
    font-size: 1.5rem !important;
}

/* Groupe √† droite (devise, langue, dashboard/login) */
.header-right-group {
    display: flex !important;
    align-items: center !important;
    gap: 15px !important;
    margin-left: auto !important;
    order: 3;
}

.main-header .currency-selector {
    margin: 0;
}

.main-header .currency-selector select {
    border: 1px solid #ddd;
    color: #333;
    padding: 5px 8px;
    font-size: 0.85rem;
    border-radius: 15px;
    background: white;
    min-width: 70px;
}

.language-switcher {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
    font-weight: 500;
    color: #333;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 20px;
    transition: background-color 0.3s;
}

.language-switcher:hover {
    background-color: #f5f5f5;
}

/* Masquer le menu hamburger et les liens de navigation */
.main-header .hamburger-menu {
    display: none !important;
}

.main-header .nav-link {
    display: none !important;
}

.main-header .nav-spacer {
    display: none !important;
}

/* BOUTONS DUR√âE - COULEUR #4781db */
.duration-option {
    flex: 1;
    min-width: 80px;
    padding: 12px 15px;
    background: #f8f9fa;
    border: 2px solid #e0e0e0;
    border-radius: 50px;
    font-weight: 600;
    font-size: 0.95rem;
    color: #555;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
    white-space: nowrap;
}

.duration-option:hover {
    border-color: #4781db;
    background: #f0f7ff;
    color: #4781db;
}

.duration-option.selected {
    background: #4781db;
    border-color: #4781db;
    color: white;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(71, 129, 219, 0.3);
}

/* BOUTONS PACKAGE - COULEUR #3c84f6 */
.courses-count-option {
    flex: 1;
    min-width: 70px;
    padding: 12px 10px;
    background: #f8f9fa;
    border: 2px solid #e0e0e0;
    border-radius: 50px;
    font-weight: 600;
    font-size: 0.9rem;
    color: #555;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
    position: relative;
}

.courses-count-option:hover {
    border-color: #3c84f6;
    background: #f0f7ff;
    color: #3c84f6;
}

.courses-count-option.selected {
    background: #3c84f6;
    border-color: #3c84f6;
    color: white;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(60, 132, 246, 0.3);
}

/* BADGE R√âDUCTION - COULEUR #f6ae3b */
.discount-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #f6ae3b;
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: bold;
}

/* BOUTONS OUTIL VISIO - COULEUR #3069c4 */
.location-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex: 1;
    min-width: 80px;
    padding: 12px 15px;
    background: #f8f9fa;
    border: 2px solid #e0e0e0;
    border-radius: 50px;
    font-weight: 600;
    font-size: 0.95rem;
    color: #555;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
    white-space: nowrap;
}

.location-btn i {
    font-size: 1.1rem;
}

.location-btn:hover {
    border-color: #3069c4;
    background: #f0f7ff;
    color: #3069c4;
}

.location-btn.selected {
    background: #3069c4;
    border-color: #3069c4;
    color: white;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(48, 105, 196, 0.3);
}

/* Ajuster l'espacement des groupes de boutons */
.duration-options,
.courses-count-options {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
}

/* MOBILE - Header ajust√© */
@media (max-width: 768px) {
    .main-header {
        min-height: 55px !important;
    }
    
    .header-content {
        padding: 8px 0 !important;
    }
    
    .logo {
        font-size: 1.3rem !important;
    }
    
    .mobile-login-btn-header {
        display: block !important;
        padding: 6px 12px !important;
        font-size: 0.85rem !important;
        order: 3;
        z-index: 1001;
        background-color: #4f9ad1;
        color: white;
        border-radius: 20px;
        text-decoration: none;
        margin-left: auto;
    }
    
    /* Logo centr√© sur mobile */
    .logo-section {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        order: 2;
    }
    
    /* Masquer le groupe droit sur mobile */
    .header-right-group {
        display: none !important;
    }
    
    /* Cacher le s√©lecteur de devise sur mobile */
    .main-header .currency-selector {
        display: none;
    }
    
    body {
        padding-top: 55px !important;
    }
    
    .booking-section {
        min-height: calc(100vh - 55px);
    }
    
    /* R√©duire les boutons sur mobile */
    .duration-options,
    .courses-count-options {
        gap: 8px;
    }
    
    .duration-option,
    .courses-count-option,
    .location-btn {
        min-width: 70px;
        padding: 10px 12px;
        font-size: 0.9rem;
    }
}

@media (max-width: 480px) {
    .duration-options,
    .courses-count-options {
        gap: 6px;
    }
    
    .duration-option,
    .courses-count-option,
    .location-btn {
        min-width: 60px;
        padding: 8px 10px;
        font-size: 0.85rem;
    }
}

/* Masquer le bouton mobile sur desktop */
@media (min-width: 769px) {
    .mobile-login-btn-header {
        display: none !important;
    }
    
    .header-right-group {
        display: flex !important;
    }
    
    /* Logo √† gauche sur desktop */
    .logo-section {
        position: static;
        transform: none;
    }
}
    </style>
</head>
<body>
    <!-- Header r√©duit -->
    <header class="main-header scrolled">
        <div class="container">
            <div class="header-content">
                <button class="hamburger-menu" id="hamburgerBtn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                
                <div class="logo-section">
                    <a href="index.html" class="logo">Yoann</a>
                    <div class="flag">üá´üá∑</div>
                </div>
                
                <a href="login.html" class="mobile-login-btn-header">Connexion</a>
                
                <nav class="nav-menu desktop-menu">
                    <!-- Groupe droit pour langue, devise et avatar -->
                    <div class="header-right-group">
                        <!-- Avatar utilisateur -->
                        <div class="user-avatar" id="userAvatar" style="display: none;">
                            <div class="avatar-img" id="avatarInitials">Y</div>
                            <div class="user-menu">
                                <a href="dashboard.html">Mon tableau de bord</a>
                                <a href="profile.html">Mon profil</a>
                                <a href="bookings.html">Mes r√©servations</a>
                                <a href="#" class="logout-btn" id="logoutBtn">D√©connexion</a>
                            </div>
                        </div>
                        
                        <!-- S√©lecteur de devise -->
                        <div class="currency-selector">
                            <select id="currencySelector">
                                <!-- Rempli dynamiquement par currency.js -->
                            </select>
                        </div>
                        
                        <!-- S√©lecteur de langue -->
                        <div class="language-switcher">
                            <span class="flag">üåê</span>
                            <span>FR</span>
                        </div>
                    </div>
                    
                    <!-- Bouton de connexion (visible si non connect√©) -->
                    <a href="login.html" class="login-btn" id="loginBtn">Connexion</a>
                </nav>
            </div>
        </div>
    </header>

    <section class="booking-section">
        <div class="booking-container">
            <div class="booking-header">
                <h1 class="booking-title">R√©server un cours</h1>
                <p class="booking-subtitle">Choisissez la date, l'heure et le type de cours qui vous convient</p>
                <!-- La notification de devise a √©t√© retir√©e -->
            </div>

            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
            </div>

            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i> <span id="successText"></span>
            </div>

            <div class="booking-grid">
                <!-- Colonne gauche : Calendrier et cr√©neaux -->
                <div class="booking-card">
                    <h2 class="card-title">Choisir un cr√©neau</h2>
                    
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="month-year" id="currentMonth">Janvier 2024</div>
                            <div class="calendar-nav">
                                <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                                <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        
                        <div class="calendar-grid" id="calendarDays">
                            <!-- Les jours seront g√©n√©r√©s par JavaScript -->
                        </div>
                    </div>

                    <h3 style="margin-bottom: 15px;">Cr√©neaux disponibles</h3>
                    <div class="time-slots" id="timeSlots">
                        <!-- Les cr√©neaux seront g√©n√©r√©s par JavaScript -->
                    </div>
                </div>

                <!-- Colonne droite : Formulaire et r√©capitulatif -->
                <div class="booking-card">
                    <h2 class="card-title">D√©tails de la r√©servation</h2>
                    
                    <!-- Message de connexion requise -->
                    <div class="login-required" id="loginRequired" style="display: none;">
                        <i class="fas fa-info-circle"></i> Pour r√©server un cours <span id="courseTypeName"></span>, 
                        <a href="login.html" id="loginLink">connectez-vous</a> ou 
                        <a href="signup.html" id="signupLink">cr√©ez un compte</a>.
                    </div>
                    
                    <form id="bookingForm">
                        <div class="form-group">
                            <label class="form-label" for="courseType">Type de cours</label>
                            <select id="courseType" class="form-select" required>
                                <option value="">S√©lectionnez un type de cours</option>
                                <option value="essai">Cours d'essai (15 min)</option>
                                <option value="conversation">Conversation</option>
                                <option value="curriculum">Curriculum complet</option>
                                <option value="examen">Pr√©paration d'examen</option> <!-- NOUVEAU -->
                            </select>
                        </div>

                        <!-- S√©lecteur de dur√©e en bulles cliquables -->
                        <div class="form-group duration-group" id="durationGroup">
                            <label class="form-label">Dur√©e du cours</label>
                            <div class="duration-options">
                                <button type="button" class="duration-option" data-duration="30" data-price-eur="10">30 min</button>
                                <button type="button" class="duration-option" data-duration="45" data-price-eur="15">45 min</button>
                                <button type="button" class="duration-option" data-duration="60" data-price-eur="20" data-selected="true">60 min</button>
                            </div>
                            <input type="hidden" id="duration" value="60">
                            <input type="hidden" id="basePriceEUR" value="20">
                        </div>

                        <!-- Nouveau: S√©lecteur du nombre de cours -->
                        <div class="form-group courses-count-group" id="coursesCountGroup">
                            <label class="form-label">Nombre de cours</label>
                            <div class="courses-count-options">
                                <button type="button" class="courses-count-option selected" data-count="1" data-discount="0">
                                    1 cours
                                </button>
                                <button type="button" class="courses-count-option" data-count="5" data-discount="2">
                                    5 cours
                                    <span class="discount-badge">-2%</span>
                                </button>
                                <button type="button" class="courses-count-option" data-count="10" data-discount="5">
                                    10 cours
                                    <span class="discount-badge">-5%</span>
                                </button>
                            </div>
                            <input type="hidden" id="coursesCount" value="10">
                            <input type="hidden" id="discountPercent" value="5">
                        </div>

                        <!-- S√©lecteur de moyen de communication -->
                        <div class="form-group" id="locationGroup">
                            <label class="form-label">Moyen de communication</label>
                            <div class="duration-options">
                                <button type="button" class="duration-option location-btn selected" data-location="integrations:zoom">
                                    <i class="fab fa-zoom"></i> Zoom
                                </button>
                                <button type="button" class="duration-option location-btn" data-location="https://teams.live.com/l/invite/FEAJFWoKc8mbrQCGwM?v=g1">
                                    <i class="fab fa-microsoft"></i> Teams
                                </button>
 <button type="button" class="duration-option location-btn" data-location="integrations:google:meet">
                                    <i class="fab fa-google"></i> Meet
                                </button>
                            </div>
                            <input type="hidden" id="selectedLocation" value="integrations:google:meet">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="name">Nom complet</label>
                            <input type="text" id="name" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="email">Email</label>
                            <input type="email" id="email" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="notes">Notes pour le professeur (optionnel)</label>
                            <textarea id="notes" class="form-textarea" placeholder="Votre niveau, objectifs, sujets de discussion pr√©f√©r√©s..."></textarea>
                        </div>

                        <div class="booking-summary">
                            <h3 style="margin-bottom: 15px;">R√©capitulatif</h3>
                            <div class="summary-item">
                                <span>Type de cours:</span>
                                <span id="summaryType">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Nombre de cours:</span>
                                <span id="summaryCoursesCount">1 cours</span>
                            </div>
                            <div class="summary-item">
                                <span>R√©duction:</span>
                                <span id="summaryDiscount">0%</span>
                            </div>
                            <div class="summary-item">
                                <span>Date:</span>
                                <span id="summaryDate">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Heure:</span>
                                <span id="summaryTime">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Dur√©e:</span>
                                <span id="summaryDuration">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Plateforme:</span>
                                <span id="summaryPlatform">Zoom</span>
                            </div>
                            <div class="summary-item total">
                                <span>Total:</span>
                                <span id="summaryPrice">-</span>
                            </div>
                        </div>

                        <button type="submit" class="btn-booking" id="submitBooking" disabled>
                            <i class="fas fa-calendar-check"></i> R√©server et payer
                        </button>
                        
                        <div style="margin-top: 15px; text-align: center; font-size: 0.9rem; color: #666;">
                            <i class="fas fa-lock"></i> Vous serez redirig√© vers la page de paiement apr√®s confirmation
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script src="auth.js"></script>
    <script src="booking.js"></script>
    <script src="mobile-menu.js"></script>
    <script src="common.js"></script>
    <script src="currency.js"></script>
 
    <script>
// SCRIPT JAVASCRIPT CORRIG√â POUR BOOKING.HTML
// Remplacer le script existant dans booking.html par celui-ci

document.addEventListener('DOMContentLoaded', function() {
    let selectedDate = null;
    let selectedTime = null;
    let selectedSlot = null;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    
    // NOUVELLE VARIABLE: Suivre si c'est la premi√®re initialisation
    let isFirstLoad = true;

    // √âl√©ments DOM
    const errorDiv = document.getElementById('errorMessage');
    const successDiv = document.getElementById('successMessage');
    const errorText = document.getElementById('errorText');
    const successText = document.getElementById('successText');
    const calendarDays = document.getElementById('calendarDays');
    const timeSlots = document.getElementById('timeSlots');
    const currentMonthElement = document.getElementById('currentMonth');
    const bookingForm = document.getElementById('bookingForm');
    const submitButton = document.getElementById('submitBooking');
    const durationGroup = document.getElementById('durationGroup');
    const durationInput = document.getElementById('duration');
    const basePriceInput = document.getElementById('basePriceEUR');
    const loginRequired = document.getElementById('loginRequired');
    const courseTypeName = document.getElementById('courseTypeName');
    const loginLink = document.getElementById('loginLink');
    const signupLink = document.getElementById('signupLink');
    const selectedLocationInput = document.getElementById('selectedLocation');
    const coursesCountGroup = document.getElementById('coursesCountGroup');
    const coursesCountInput = document.getElementById('coursesCount');
    const discountPercentInput = document.getElementById('discountPercent');

    // Stocker le type de cours avant redirection
    let preLoginCourseType = null;

    // Initialiser la page
    initializePage();

    // Navigation du calendrier
    document.getElementById('prevMonth').addEventListener('click', () => {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        initCalendar();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        initCalendar();
    });

    // Changement de type de cours
    document.getElementById('courseType').addEventListener('change', function() {
        const courseType = this.value;
        preLoginCourseType = courseType;
        updateUIForCourseType(courseType, true);
        if (selectedDate) {
            loadAvailableSlots(selectedDate);
        }
        updateSummary();
    });

    // Gestion des boutons de dur√©e
    document.querySelectorAll('.duration-option').forEach(button => {
        if (button.hasAttribute('data-duration')) {
            button.addEventListener('click', function(e) {
                e.preventDefault(); // Emp√™cher tout comportement par d√©faut
                
                // Retirer la s√©lection pr√©c√©dente
                document.querySelectorAll('.duration-option[data-duration]').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // Ajouter la nouvelle s√©lection
                this.classList.add('selected');
                
                // Mettre √† jour la valeur
                const duration = this.getAttribute('data-duration');
                durationInput.value = duration;
                
                // Mettre √† jour le prix de base
                const basePrice = this.getAttribute('data-price-eur') || '20';
                basePriceInput.value = basePrice;
                
                // Recharger les cr√©neaux si une date est s√©lectionn√©e
                if (selectedDate) {
                    loadAvailableSlots(selectedDate);
                }
                
                updateSummary();
            });
        }
    });

    // Gestion des boutons de nombre de cours
    document.querySelectorAll('.courses-count-option').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault(); // Emp√™cher tout comportement par d√©faut
            
            // Retirer la s√©lection pr√©c√©dente
            document.querySelectorAll('.courses-count-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Ajouter la nouvelle s√©lection
            this.classList.add('selected');
            
            // Mettre √† jour les valeurs
            const count = this.getAttribute('data-count');
            const discount = this.getAttribute('data-discount');
            coursesCountInput.value = count;
            discountPercentInput.value = discount;
            
            updateSummary();
        });
    });

    // Gestion des boutons de moyen de communication
    document.querySelectorAll('.location-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault(); // Emp√™cher tout comportement par d√©faut
            
            // Retirer la s√©lection pr√©c√©dente
            document.querySelectorAll('.location-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Ajouter la nouvelle s√©lection
            this.classList.add('selected');
            
            // Mettre √† jour la valeur
            const location = this.getAttribute('data-location');
            selectedLocationInput.value = location;
            
            updateSummary();
        });
    });

    // Soumission du formulaire
    bookingForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!selectedDate || !selectedTime) {
            showError('Veuillez s√©lectionner une date et une heure');
            return;
        }

        const courseType = document.getElementById('courseType').value;
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const notes = document.getElementById('notes').value;
        const location = selectedLocationInput.value;
        const coursesCount = parseInt(coursesCountInput.value);
        const discountPercent = parseFloat(discountPercentInput.value);

        // Validation
        if (!courseType || !name || !email) {
            showError('Veuillez remplir tous les champs obligatoires');
            return;
        }

        // V√©rifier si l'utilisateur doit √™tre connect√©
        if ((courseType === 'conversation' || courseType === 'curriculum' || courseType === 'examen') && !window.authManager?.getCurrentUser()) {
            showError('Veuillez vous connecter pour r√©server ce type de cours');
            return;
        }

        hideMessages();
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Pr√©paration du paiement...';

        try {
            // Utiliser les donn√©es du cr√©neau s√©lectionn√©
            if (!selectedSlot) {
                throw new Error('Aucun cr√©neau s√©lectionn√©');
            }

            // D√©terminer la dur√©e et le prix EN EUR (prix de base)
            let duration = selectedSlot.durationInMinutes || 15;
            let priceEUR = 5;
            
            // CORRECTION: Utiliser la dur√©e du cr√©neau pour calculer le prix
            if (courseType === 'conversation') {
                priceEUR = duration === 30 ? 10 : duration === 45 ? 15 : 20;
            } else if (courseType === 'curriculum') {
                priceEUR = duration === 30 ? 17.5 : duration === 45 ? 26.25 : 35;
            } else if (courseType === 'examen') {
                priceEUR = duration === 30 ? 15 : duration === 45 ? 22.5 : 30;
            }

            // Appliquer le nombre de cours
            let totalPriceEUR = priceEUR * coursesCount;
            
            // Appliquer la r√©duction
            if (discountPercent > 0) {
                totalPriceEUR = totalPriceEUR * (1 - discountPercent / 100);
            }

            // Convertir le prix dans la devise actuelle pour l'affichage
            const currentCurrency = window.currencyManager?.currentCurrency || 'EUR';
            const convertedPrice = window.currencyManager?.convert(totalPriceEUR, 'EUR', currentCurrency) || totalPriceEUR;
            
            const bookingData = {
                eventType: courseType,
                startTime: selectedSlot.start,
                endTime: selectedSlot.end,
                name: name,
                email: email,
                notes: notes,
                courseType: courseType,
                priceEUR: totalPriceEUR,
                basePriceEUR: priceEUR,
                price: convertedPrice,
                duration: duration,
                coursesCount: coursesCount,
                discountPercent: discountPercent,
                location: location,
                lengthInMinutes: courseType !== 'essai' ? duration : undefined,
                currency: currentCurrency
            };

            // Appeler la m√©thode qui pr√©pare les donn√©es SANS cr√©er sur Cal.com
            const result = await window.bookingManager.createBooking(bookingData);
            
            if (result.success) {
                showSuccess('Redirection vers le paiement...');
                
                // Redirection vers la page de paiement
                setTimeout(() => {
                    window.location.href = result.redirectTo;
                }, 1000);
            } else {
                throw new Error(result.error || 'Erreur inconnue');
            }

        } catch (error) {
            showError('Erreur lors de la pr√©paration : ' + error.message);
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-calendar-check"></i> R√©server et payer';
        }
    });

    // √âcouter les √©v√©nements d'authentification
    window.addEventListener('auth:login', function() {
        console.log('Utilisateur connect√©, mise √† jour de l\'interface');
        updateUserInterface();
    });

    window.addEventListener('auth:logout', function() {
        console.log('Utilisateur d√©connect√©, mise √† jour de l\'interface');
        updateUserInterface();
    });
    
    // √âcouter les changements de devise
    window.addEventListener('currency:ready', function() {
        updateSummary();
    });
    
    window.addEventListener('currency:changed', function() {
        updateSummary();
    });

    // Fonctions
    function initializePage() {
        // R√©cup√©rer le type de cours depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        let courseTypeParam = urlParams.get('type');
        
        // Si pas de param√®tre "type", v√©rifier dans localStorage
        if (!courseTypeParam || !['essai', 'conversation', 'curriculum', 'examen'].includes(courseTypeParam)) {
            const storedCourseType = localStorage.getItem('preLoginCourseType');
            
            if (storedCourseType && ['essai', 'conversation', 'curriculum', 'examen'].includes(storedCourseType)) {
                courseTypeParam = storedCourseType;
                localStorage.removeItem('preLoginCourseType');
            } else {
                courseTypeParam = 'essai';
            }
        }
        
        // Forcer la s√©lection dans le dropdown
        document.getElementById('courseType').value = courseTypeParam;
        preLoginCourseType = courseTypeParam;
        
        // Stocker aussi dans l'URL si ce n'est pas d√©j√† fait
        if (!urlParams.has('type')) {
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('type', courseTypeParam);
            window.history.replaceState({}, '', newUrl);
        }
        
        // NOUVELLE LOGIQUE: Pr√©-s√©lectionner 60min, 10 cours, Google Meet
        preselectDefaults();
        
        // Initialiser le calendrier
        initCalendar();
        
        // Charger les cr√©neaux pour aujourd'hui par d√©faut
        const today = new Date().toISOString().split('T')[0];
        selectToday(today);
        
        // Mettre √† jour l'interface
        updateUIForCourseType(document.getElementById('courseType').value, false);
        
        // Mettre √† jour l'interface utilisateur
        updateUserInterface();
        
        // Marquer que le premier chargement est termin√©
        setTimeout(() => {
            isFirstLoad = false;
        }, 1000);
    }
    
    // NOUVELLE FONCTION: Pr√©-s√©lectionner les valeurs par d√©faut
    function preselectDefaults() {
        // Pr√©-s√©lectionner 60 min
        const duration60Btn = document.querySelector('.duration-option[data-duration="60"]');
        if (duration60Btn) {
            document.querySelectorAll('.duration-option[data-duration]').forEach(btn => {
                btn.classList.remove('selected');
            });
            duration60Btn.classList.add('selected');
            durationInput.value = '60';
            basePriceInput.value = duration60Btn.getAttribute('data-price-eur') || '20';
        }
        
        // Pr√©-s√©lectionner 10 cours
        const courses10Btn = document.querySelector('.courses-count-option[data-count="10"]');
        if (courses10Btn) {
            document.querySelectorAll('.courses-count-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            courses10Btn.classList.add('selected');
            coursesCountInput.value = '10';
            discountPercentInput.value = courses10Btn.getAttribute('data-discount') || '5';
        }
        
        // Pr√©-s√©lectionner Google Meet
        const meetBtn = document.querySelector('.location-btn[data-location*="google"]');
        if (meetBtn) {
            document.querySelectorAll('.location-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            meetBtn.classList.add('selected');
            selectedLocationInput.value = meetBtn.getAttribute('data-location');
        }
    }

    function initCalendar() {
        const monthNames = [
            'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
            'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
        ];
        currentMonthElement.textContent = `${monthNames[currentMonth]} ${currentYear}`;

        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay();

        const dayHeaders = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        calendarDays.innerHTML = '';

        dayHeaders.forEach(day => {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day-header';
            dayElement.textContent = day;
            calendarDays.appendChild(dayElement);
        });

        for (let i = 0; i < startingDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day disabled';
            calendarDays.appendChild(emptyDay);
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, currentMonth, day);
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = day;
            dayElement.setAttribute('data-date', 
                `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`
            );
            
            if (date.getDate() === today.getDate() && 
                date.getMonth() === today.getMonth() && 
                date.getFullYear() === today.getFullYear()) {
                dayElement.classList.add('today');
            }

            if (date < today) {
                dayElement.classList.add('disabled');
            } else {
                dayElement.addEventListener('click', () => selectDate(
                    `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`
                ));
            }

            calendarDays.appendChild(dayElement);
        }
    }

    function selectToday(today) {
        const todayElement = document.querySelector(`.calendar-day[data-date="${today}"]`);
        if (todayElement && !todayElement.classList.contains('disabled')) {
            selectDate(today);
        } else {
            const firstAvailable = document.querySelector('.calendar-day:not(.disabled)');
            if (firstAvailable) {
                selectDate(firstAvailable.getAttribute('data-date'));
            }
        }
    }

    function updateUIForCourseType(courseType, forceUpdate = false) {
        console.log('updateUIForCourseType appel√© avec:', courseType, 'forceUpdate:', forceUpdate);
        
        preLoginCourseType = courseType;
        
        const user = window.authManager?.getCurrentUser();
        const isLoggedIn = !!user;
        
        console.log('Utilisateur connect√©:', isLoggedIn, 'User:', user);
        
        if (courseType && courseType !== 'essai') {
            const redirectUrl = `booking.html?type=${courseType}`;
            loginLink.href = `login.html?redirect=${encodeURIComponent(redirectUrl)}`;
            signupLink.href = `signup.html?redirect=${encodeURIComponent(redirectUrl)}`;
            localStorage.setItem('preLoginCourseType', courseType);
        }
        
        if (courseType === 'essai') {
            durationGroup.classList.remove('visible');
            coursesCountGroup.style.display = 'none';
            loginRequired.style.display = 'none';
        } else if (courseType === 'conversation' || courseType === 'curriculum' || courseType === 'examen') {
            if (isLoggedIn) {
                durationGroup.classList.add('visible');
                coursesCountGroup.style.display = 'block';
                loginRequired.style.display = 'none';
                console.log('S√©lecteur de dur√©e affich√© pour', courseType);
            } else {
                durationGroup.classList.remove('visible');
                coursesCountGroup.style.display = 'none';
                loginRequired.style.display = 'block';
                if (courseType === 'conversation') courseTypeName.textContent = 'Conversation';
                else if (courseType === 'curriculum') courseTypeName.textContent = 'Curriculum complet';
                else if (courseType === 'examen') courseTypeName.textContent = 'Pr√©paration d\'examen';
                console.log('Message connexion affich√© pour', courseType);
            }
        } else {
            durationGroup.classList.remove('visible');
            coursesCountGroup.style.display = 'none';
            loginRequired.style.display = 'none';
        }
        
        if (isLoggedIn && user) {
            document.getElementById('name').value = user.user_metadata?.full_name || user.email?.split('@')[0] || '';
            document.getElementById('email').value = user.email || '';
        }
        
        if (forceUpdate && selectedDate) {
            loadAvailableSlots(selectedDate);
        }
        
        updateSummary();
    }

    async function loadAvailableSlots(date = null) {
        try {
            timeSlots.innerHTML = '<div class="loading-slots"><i class="fas fa-spinner fa-spin"></i> Chargement des cr√©neaux...</div>';
            
            const courseType = document.getElementById('courseType').value || 'essai';
            
            let duration = null;
            if (courseType !== 'essai' && durationGroup.classList.contains('visible')) {
                duration = parseInt(durationInput.value) || 60;
            }
            
            const slots = await window.bookingManager.getAvailableSlots(courseType, date, duration);
            
            timeSlots.innerHTML = '';
            
            if (slots.length === 0) {
                timeSlots.innerHTML = '<p class="no-slots">Aucun cr√©neau disponible pour cette date.</p>';
                return;
            }

            let hasFutureSlots = false;
            
            slots.forEach(slot => {
                const slotDate = new Date(slot.start);
                const now = new Date();
                
                if (slotDate > now) {
                    hasFutureSlots = true;
                    const slotElement = document.createElement('div');
                    slotElement.className = 'time-slot';
                    slotElement.innerHTML = `
                        <div class="time-slot-time">
                            <i class="far fa-clock"></i>
                            ${slotDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}
                        </div>
                        <div class="time-slot-duration">
                            ${window.bookingManager.formatTime(slot.start)} - ${slot.duration}
                        </div>
                    `;
                    
                    slotElement.addEventListener('click', () => selectTimeSlot(slot, slotElement));
                    timeSlots.appendChild(slotElement);
                }
            });

            if (!hasFutureSlots) {
                timeSlots.innerHTML = '<p class="no-slots">Tous les cr√©neaux sont complets pour aujourd\'hui.</p>';
            }

        } catch (error) {
            console.error('Erreur chargement cr√©neaux:', error);
            timeSlots.innerHTML = `
                <div class="error-slots">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Erreur lors du chargement des cr√©neaux</p>
                    <p class="error-details">${error.message || 'Veuillez r√©essayer'}</p>
                    <button onclick="loadAvailableSlots('${date}')" class="retry-btn">
                        <i class="fas fa-redo"></i> R√©essayer
                    </button>
                </div>
            `;
        }
    }

    function selectDate(date) {
        selectedDate = date;
        
        document.querySelectorAll('.calendar-day').forEach(dayEl => {
            dayEl.classList.remove('selected');
        });
        
        const selectedDayElement = document.querySelector(`.calendar-day[data-date="${date}"]`);
        if (selectedDayElement) {
            selectedDayElement.classList.add('selected');
        }
        
        loadAvailableSlots(selectedDate);
        updateSummary();
    }

    function selectTimeSlot(slot, element) {
        // Retirer la s√©lection pr√©c√©dente
        document.querySelectorAll('.time-slot').forEach(slotEl => {
            slotEl.classList.remove('selected');
        });

        // Ajouter la nouvelle s√©lection
        element.classList.add('selected');
        
        selectedSlot = slot;
        selectedTime = new Date(slot.start).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        
        // NE PLUS changer automatiquement la dur√©e s√©lectionn√©e
        // L'utilisateur garde sa s√©lection
        
        updateSummary();
    }

    function updateSummary() {
        const courseType = document.getElementById('courseType').value;
        const user = window.authManager?.getCurrentUser();
        let courseName = '-';
        let price = '-';
        let duration = '-';
        let platform = 'Google Meet'; // D√©faut chang√© √† Google Meet
        const coursesCount = parseInt(coursesCountInput.value);
        const discountPercent = parseFloat(discountPercentInput.value);

        // D√©terminer la plateforme
        const locationValue = selectedLocationInput.value;
        if (locationValue.includes('zoom')) platform = 'Zoom';
        else if (locationValue.includes('google')) platform = 'Google Meet';
        else if (locationValue.includes('teams')) platform = 'Microsoft Teams';

        // Calculer en fonction du type de cours
        if (courseType === 'essai') {
            courseName = 'Cours d\'essai';
            let unitPriceEUR = 5;
            let totalPriceEUR = unitPriceEUR * coursesCount;
            
            if (window.currencyManager) {
                price = window.currencyManager.formatPrice(totalPriceEUR);
            } else {
                price = totalPriceEUR + '‚Ç¨';
            }
            duration = '15 min';
        } else if (courseType === 'conversation') {
            courseName = 'Conversation';
            if (user && durationGroup.classList.contains('visible')) {
                const selectedDuration = selectedSlot ? selectedSlot.durationInMinutes : (parseInt(durationInput.value) || 60);
                duration = selectedDuration + ' min';
                
                let unitPriceEUR = 20;
                if (selectedDuration === 30) unitPriceEUR = 10;
                else if (selectedDuration === 45) unitPriceEUR = 15;
                
                let totalPriceEUR = unitPriceEUR * coursesCount;
                if (discountPercent > 0) {
                    totalPriceEUR = totalPriceEUR * (1 - discountPercent / 100);
                }
                
                if (window.currencyManager) {
                    price = window.currencyManager.formatPrice(totalPriceEUR);
                } else {
                    price = totalPriceEUR + '‚Ç¨';
                }
            } else {
                duration = '60 min';
                let unitPriceEUR = 20;
                let totalPriceEUR = unitPriceEUR * coursesCount;
                
                if (window.currencyManager) {
                    price = window.currencyManager.formatPrice(totalPriceEUR);
                } else {
                    price = totalPriceEUR + '‚Ç¨';
                }
            }
        } else if (courseType === 'curriculum') {
            courseName = 'Curriculum complet';
            if (user && durationGroup.classList.contains('visible')) {
                const selectedDuration = selectedSlot ? selectedSlot.durationInMinutes : (parseInt(durationInput.value) || 60);
                duration = selectedDuration + ' min';
                
                let unitPriceEUR = 35;
                if (selectedDuration === 30) unitPriceEUR = 17.5;
                else if (selectedDuration === 45) unitPriceEUR = 26.25;
                
                let totalPriceEUR = unitPriceEUR * coursesCount;
                if (discountPercent > 0) {
                    totalPriceEUR = totalPriceEUR * (1 - discountPercent / 100);
                }
                
                if (window.currencyManager) {
                    price = window.currencyManager.formatPrice(totalPriceEUR);
                } else {
                    price = totalPriceEUR + '‚Ç¨';
                }
            } else {
                duration = '60 min';
                let unitPriceEUR = 35;
                let totalPriceEUR = unitPriceEUR * coursesCount;
                
                if (window.currencyManager) {
                    price = window.currencyManager.formatPrice(totalPriceEUR);
                } else {
                    price = totalPriceEUR + '‚Ç¨';
                }
            }
        } else if (courseType === 'examen') {
            courseName = 'Pr√©paration d\'examen';
            if (user && durationGroup.classList.contains('visible')) {
                const selectedDuration = selectedSlot ? selectedSlot.durationInMinutes : (parseInt(durationInput.value) || 60);
                duration = selectedDuration + ' min';
                
                let unitPriceEUR = 30;
                if (selectedDuration === 30) unitPriceEUR = 15;
                else if (selectedDuration === 45) unitPriceEUR = 22.5;
                
                let totalPriceEUR = unitPriceEUR * coursesCount;
                if (discountPercent > 0) {
                    totalPriceEUR = totalPriceEUR * (1 - discountPercent / 100);
                }
                
                if (window.currencyManager) {
                    price = window.currencyManager.formatPrice(totalPriceEUR);
                } else {
                    price = totalPriceEUR + '‚Ç¨';
                }
            } else {
                duration = '60 min';
                let unitPriceEUR = 30;
                let totalPriceEUR = unitPriceEUR * coursesCount;
                
                if (window.currencyManager) {
                    price = window.currencyManager.formatPrice(totalPriceEUR);
                } else {
                    price = totalPriceEUR + '‚Ç¨';
                }
            }
        }

        document.getElementById('summaryType').textContent = courseName;
        document.getElementById('summaryCoursesCount').textContent = `${coursesCount} cours`;
        document.getElementById('summaryDiscount').textContent = discountPercent > 0 ? `-${discountPercent}%` : '0%';
        document.getElementById('summaryDate').textContent = selectedDate ? 
            new Date(selectedDate).toLocaleDateString('fr-FR') : '-';
        document.getElementById('summaryTime').textContent = selectedTime || '-';
        document.getElementById('summaryDuration').textContent = duration;
        document.getElementById('summaryPlatform').textContent = platform;
        document.getElementById('summaryPrice').textContent = price;

        const canSubmit = selectedDate && selectedTime && courseType && 
            (courseType === 'essai' || (user && durationGroup.classList.contains('visible')));
        
        submitButton.disabled = !canSubmit;
    }

    function showError(message) {
        errorText.textContent = message;
        errorDiv.style.display = 'block';
        successDiv.style.display = 'none';
    }

    function showSuccess(message) {
        successText.textContent = message;
        successDiv.style.display = 'block';
        errorDiv.style.display = 'none';
    }

    function hideMessages() {
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';
    }
    
    function updateUserInterface() {
        const user = window.authManager?.getCurrentUser();
        const isLoggedIn = !!user;
        
        if (isLoggedIn && user) {
            // Mettre √† jour les informations du formulaire
            document.getElementById('name').value = user.user_metadata?.full_name || user.email?.split('@')[0] || '';
            document.getElementById('email').value = user.email || '';
        }
        
        // Mettre √† jour l'interface en fonction du type de cours
        const currentCourseType = document.getElementById('courseType').value;
        updateUIForCourseType(currentCourseType, true);
    }
});
    </script>
</body>
</html>