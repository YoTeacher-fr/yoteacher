<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©server un cours - YoTeacher</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üá´üá∑</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* R√âDUCTION DE LA HAUTEUR DU HEADER */
        .main-header {
            background-color: rgba(255, 255, 255, 0.98) !important;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1) !important;
            backdrop-filter: blur(10px) !important;
            min-height: 60px !important; /* R√©duit la hauteur */
        }
        
        .header-content {
            padding: 10px 0 !important; /* R√©duit le padding vertical */
        }
        
        .main-header .nav-link {
            display: none !important;
        }
        
        .main-header .nav-spacer {
            display: none !important;
        }
        
        .main-header .logo {
            color: #333 !important;
            font-weight: 700;
            font-size: 1.5rem !important; /* Logo plus petit */
        }
        
        .main-header .login-btn {
            background-color: #4f9ad1 !important;
            color: white !important;
            padding: 8px 20px !important; /* Bouton plus petit */
            font-size: 0.9rem !important;
        }
        
        /* CORRECTION DU PADDING DU BODY */
        body {
            padding-top: 60px !important; /* Ajust√© √† la nouvelle hauteur du header */
        }
        
        /* FOND INITIAL DE BOOKING */
        .booking-section {
            padding: 40px 20px; /* Espacement sym√©trique */
            background: #f8f9fa; /* Fond gris clair initial */
            min-height: calc(100vh - 60px); /* Prend en compte le header r√©duit */
        }

        .booking-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .booking-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .booking-title {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 15px;
        }

        .booking-subtitle {
            color: #666;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .booking-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .booking-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid #eaeaea;
        }

        .card-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .calendar-container {
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .month-year {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .calendar-nav button:hover {
            background: #f0f0f0;
            border-color: #3c84f6;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .calendar-day-header {
            text-align: center;
            padding: 10px;
            font-weight: 600;
            color: #666;
            font-size: 0.9rem;
        }

        .calendar-day {
            text-align: center;
            padding: 12px 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .calendar-day:hover {
            background: #f0f7ff;
        }

        .calendar-day.selected {
            background: #3c84f6;
            color: white;
        }

        .calendar-day.disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .calendar-day.today {
            border: 2px solid #3c84f6;
        }

        .time-slots {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .time-slot {
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-slot:hover {
            border-color: #3c84f6;
            background: #f0f7ff;
        }

        .time-slot.selected {
            background: #3c84f6;
            color: white;
            border-color: #3c84f6;
        }

        .time-slot.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .time-slot-time {
            font-weight: 600;
        }

        .time-slot-duration {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3c84f6;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .booking-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .summary-item.total {
            font-weight: 600;
            font-size: 1.2rem;
            border-bottom: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #ddd;
        }

        .btn-booking {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3c84f6, #1e88e5);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-booking:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(60, 132, 246, 0.3);
        }

        .btn-booking:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #ffeaea;
            color: #d32f2f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #d32f2f;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #2e7d32;
        }

        .loading-slots {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-slots i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #3c84f6;
        }

        .no-slots {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .error-slots {
            text-align: center;
            padding: 30px;
            background: #ffeaea;
            border-radius: 10px;
            color: #d32f2f;
        }

        .error-slots i {
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .error-details {
            font-size: 0.9rem;
            margin: 10px 0;
            opacity: 0.8;
        }

        .retry-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: #3c84f6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .retry-btn:hover {
            background: #2c74e6;
        }
        
        /* NOUVEAUX STYLES POUR LES BULLES DE DUR√âE */
        .duration-group {
            display: none;
        }
        
        .duration-group.visible {
            display: block;
        }
        
        .duration-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .duration-option {
            flex: 1;
            min-width: 80px;
            padding: 12px 15px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.95rem;
            color: #555;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            white-space: nowrap;
        }
        
        .duration-option:hover {
            border-color: #3c84f6;
            background: #f0f7ff;
            color: #3c84f6;
        }
        
        .duration-option.selected {
            background: #3c84f6;
            border-color: #3c84f6;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(60, 132, 246, 0.3);
        }
        
        .login-required {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .login-required a {
            color: #3c84f6;
            font-weight: 600;
            text-decoration: none;
        }
        
        .login-required a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .booking-section {
                padding: 30px 15px;
                min-height: calc(100vh - 60px);
            }
            
            .booking-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }
            
            .booking-title {
                font-size: 2rem;
            }
            
            .calendar-grid {
                gap: 3px;
            }
            
            .calendar-day {
                padding: 8px 3px;
                font-size: 0.9rem;
            }
            
            .booking-card {
                padding: 25px 20px;
            }
            
            .duration-options {
                gap: 8px;
            }
            
            .duration-option {
                min-width: 70px;
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            /* Header mobile ajust√© */
            .main-header {
                min-height: 55px !important;
            }
            
            .header-content {
                padding: 8px 0 !important;
            }
            
            .logo {
                font-size: 1.3rem !important;
            }
            
            .mobile-login-btn-header {
                padding: 6px 12px !important;
                font-size: 0.85rem !important;
                order: 3;
                z-index: 1001;
            }
            
            body {
                padding-top: 55px !important;
            }
            
            .booking-section {
                min-height: calc(100vh - 55px);
            }
        }
        
        @media (max-width: 480px) {
            .booking-card {
                padding: 20px 15px;
            }
            
            .booking-title {
                font-size: 1.8rem;
            }
            
            .card-title {
                font-size: 1.3rem;
            }
            
            .btn-booking {
                padding: 14px;
            }
            
            .form-input, .form-select, .form-textarea {
                padding: 10px 12px;
            }
            
            .duration-options {
                gap: 6px;
            }
            
            .duration-option {
                min-width: 60px;
                padding: 8px 10px;
                font-size: 0.85rem;
            }
        }
        
        /* Animation subtile pour les cartes */
        .booking-card {
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Header r√©duit -->
    <header class="main-header scrolled">
        <div class="container">
            <div class="header-content">
                <button class="hamburger-menu" id="hamburgerBtn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                
                <div class="logo-section">
                    <a href="index.html" class="logo">Yoann</a>
                    <div class="flag">üá´üá∑</div>
                </div>
                
                <a href="login.html" class="mobile-login-btn-header">Connexion</a>
                
                <nav class="nav-menu desktop-menu">
                    <!-- Supprim√© les liens de navigation -->
                    
                    <div class="language-switcher">
                        <span class="flag">üåê</span>
                        <span>FR</span>
                    </div>
                    
                    <a href="login.html" class="login-btn">Connexion</a>
                </nav>
            </div>
        </div>
    </header>

    <section class="booking-section">
        <div class="booking-container">
            <div class="booking-header">
                <h1 class="booking-title">R√©server un cours</h1>
                <p class="booking-subtitle">Choisissez la date, l'heure et le type de cours qui vous convient</p>
            </div>

            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
            </div>

            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i> <span id="successText"></span>
            </div>

            <div class="booking-grid">
                <!-- Colonne gauche : Calendrier et cr√©neaux -->
                <div class="booking-card">
                    <h2 class="card-title">Choisir un cr√©neau</h2>
                    
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="month-year" id="currentMonth">Janvier 2024</div>
                            <div class="calendar-nav">
                                <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                                <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        
                        <div class="calendar-grid" id="calendarDays">
                            <!-- Les jours seront g√©n√©r√©s par JavaScript -->
                        </div>
                    </div>

                    <h3 style="margin-bottom: 15px;">Cr√©neaux disponibles</h3>
                    <div class="time-slots" id="timeSlots">
                        <!-- Les cr√©neaux seront g√©n√©r√©s par JavaScript -->
                    </div>
                </div>

                <!-- Colonne droite : Formulaire et r√©capitulatif -->
                <div class="booking-card">
                    <h2 class="card-title">D√©tails de la r√©servation</h2>
                    
                    <!-- Message de connexion requise -->
                    <div class="login-required" id="loginRequired" style="display: none;">
                        <i class="fas fa-info-circle"></i> Pour r√©server un cours <span id="courseTypeName"></span>, 
                        <a href="login.html" id="loginLink">connectez-vous</a> ou 
                        <a href="signup.html" id="signupLink">cr√©ez un compte</a>.
                    </div>
                    
                    <form id="bookingForm">
                        <div class="form-group">
                            <label class="form-label" for="courseType">Type de cours</label>
                            <select id="courseType" class="form-select" required>
                                <option value="">S√©lectionnez un type de cours</option>
                                <option value="essai">Cours d'essai (5‚Ç¨ - 15 min)</option>
                                <option value="conversation">Conversation</option>
                                <option value="curriculum">Curriculum complet</option>
                            </select>
                        </div>

                        <!-- S√©lecteur de dur√©e en bulles cliquables -->
                        <div class="form-group duration-group" id="durationGroup">
                            <label class="form-label">Dur√©e du cours</label>
                            <div class="duration-options">
                                <button type="button" class="duration-option" data-duration="30">30 min</button>
                                <button type="button" class="duration-option" data-duration="45">45 min</button>
                                <button type="button" class="duration-option" data-duration="60" data-selected="true">60 min</button>
                            </div>
                            <input type="hidden" id="duration" value="60">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="name">Nom complet</label>
                            <input type="text" id="name" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="email">Email</label>
                            <input type="email" id="email" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="notes">Notes pour le professeur (optionnel)</label>
                            <textarea id="notes" class="form-textarea" placeholder="Votre niveau, objectifs, sujets de discussion pr√©f√©r√©s..."></textarea>
                        </div>

                        <div class="booking-summary">
                            <h3 style="margin-bottom: 15px;">R√©capitulatif</h3>
                            <div class="summary-item">
                                <span>Type de cours:</span>
                                <span id="summaryType">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Date:</span>
                                <span id="summaryDate">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Heure:</span>
                                <span id="summaryTime">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Dur√©e:</span>
                                <span id="summaryDuration">-</span>
                            </div>
                            <div class="summary-item total">
                                <span>Total:</span>
                                <span id="summaryPrice">-</span>
                            </div>
                        </div>

                        <button type="submit" class="btn-booking" id="submitBooking" disabled>
                            <i class="fas fa-calendar-check"></i> R√©server et payer
                        </button>
                        
                        <div style="margin-top: 15px; text-align: center; font-size: 0.9rem; color: #666;">
                            <i class="fas fa-lock"></i> Vous serez redirig√© vers la page de paiement apr√®s confirmation
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script src="auth.js"></script>
    <script src="booking.js"></script>
    <script src="mobile-menu.js"></script>
    <script src="common.js"></script>
    <script src="currency.js"></script>
    <script src="packages.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        let selectedDate = null;
        let selectedTime = null;
        let selectedSlot = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // √âl√©ments DOM
        const errorDiv = document.getElementById('errorMessage');
        const successDiv = document.getElementById('successMessage');
        const errorText = document.getElementById('errorText');
        const successText = document.getElementById('successText');
        const calendarDays = document.getElementById('calendarDays');
        const timeSlots = document.getElementById('timeSlots');
        const currentMonthElement = document.getElementById('currentMonth');
        const bookingForm = document.getElementById('bookingForm');
        const submitButton = document.getElementById('submitBooking');
        const durationGroup = document.getElementById('durationGroup');
        const durationInput = document.getElementById('duration');
        const loginRequired = document.getElementById('loginRequired');
        const courseTypeName = document.getElementById('courseTypeName');
        const loginLink = document.getElementById('loginLink');
        const signupLink = document.getElementById('signupLink');

        // Stocker le type de cours avant redirection
        let preLoginCourseType = null;

        // Initialiser la page
        initializePage();

        // Navigation du calendrier
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            initCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            initCalendar();
        });

        // Changement de type de cours
        document.getElementById('courseType').addEventListener('change', function() {
            const courseType = this.value;
            preLoginCourseType = courseType; // Stocker pour redirection
            updateUIForCourseType(courseType, true);
            if (selectedDate) {
                loadAvailableSlots(selectedDate);
            }
            updateSummary();
        });

        // Gestion des boutons de dur√©e
        document.querySelectorAll('.duration-option').forEach(button => {
            button.addEventListener('click', function() {
                // Retirer la s√©lection pr√©c√©dente
                document.querySelectorAll('.duration-option').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // Ajouter la nouvelle s√©lection
                this.classList.add('selected');
                
                // Mettre √† jour la valeur
                const duration = this.getAttribute('data-duration');
                durationInput.value = duration;
                
                // Recharger les cr√©neaux si une date est s√©lectionn√©e
                if (selectedDate) {
                    loadAvailableSlots(selectedDate);
                }
                
                updateSummary();
            });
        });

        // Soumission du formulaire - MODIFI√â POUR NE PAS CR√âER SUR CAL.COM
        bookingForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!selectedDate || !selectedTime) {
                showError('Veuillez s√©lectionner une date et une heure');
                return;
            }

            const courseType = document.getElementById('courseType').value;
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const notes = document.getElementById('notes').value;

            // Validation
            if (!courseType || !name || !email) {
                showError('Veuillez remplir tous les champs obligatoires');
                return;
            }

            // V√©rifier si l'utilisateur doit √™tre connect√©
            if ((courseType === 'conversation' || courseType === 'curriculum') && !window.authManager?.getCurrentUser()) {
                showError('Veuillez vous connecter pour r√©server ce type de cours');
                return;
            }

            hideMessages();
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Pr√©paration du paiement...';

            try {
                // Utiliser les donn√©es du cr√©neau s√©lectionn√©
                if (!selectedSlot) {
                    throw new Error('Aucun cr√©neau s√©lectionn√©');
                }

                // D√©terminer la dur√©e et le prix
                let duration = selectedSlot.durationInMinutes || 15;
                let price = 5;
                
                // CORRECTION IMPORTANTE: Utiliser la dur√©e du cr√©neau pour calculer le prix
                if (courseType === 'conversation') {
                    // Tarifs conversation: 30=10‚Ç¨, 45=15‚Ç¨, 60=20‚Ç¨
                    price = duration === 30 ? 10 : duration === 45 ? 15 : 20;
                } else if (courseType === 'curriculum') {
                    // Tarifs curriculum: 30=17.5‚Ç¨, 45=26.25‚Ç¨, 60=35‚Ç¨
                    price = duration === 30 ? 17.5 : duration === 45 ? 26.25 : 35;
                }

                const bookingData = {
                    eventType: courseType,
                    startTime: selectedSlot.start,
                    endTime: selectedSlot.end,
                    name: name,
                    email: email,
                    notes: notes,
                    courseType: courseType,
                    price: price,
                    duration: duration,
                    lengthInMinutes: courseType !== 'essai' ? duration : undefined
                };

                // Appeler la m√©thode qui pr√©pare les donn√©es SANS cr√©er sur Cal.com
                const result = await window.bookingManager.createBooking(bookingData);
                
                if (result.success) {
                    showSuccess('Redirection vers le paiement...');
                    
                    // Redirection vers la page de paiement
                    setTimeout(() => {
                        window.location.href = result.redirectTo;
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }

            } catch (error) {
                showError('Erreur lors de la pr√©paration : ' + error.message);
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-calendar-check"></i> R√©server et payer';
            }
        });

        // √âcouter les √©v√©nements d'authentification
        window.addEventListener('auth:login', function() {
            console.log('Utilisateur connect√©, mise √† jour de l\'interface');
            // Recharger l'interface avec le type de cours actuel
            const currentCourseType = document.getElementById('courseType').value;
            updateUIForCourseType(currentCourseType, true);
        });

        window.addEventListener('auth:logout', function() {
            console.log('Utilisateur d√©connect√©, mise √† jour de l\'interface');
            // Recharger l'interface avec le type de cours actuel
            const currentCourseType = document.getElementById('courseType').value;
            updateUIForCourseType(currentCourseType, true);
        });

        // Fonctions
        function initializePage() {
            // R√©cup√©rer le type de cours depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            let courseTypeParam = urlParams.get('type');
            
            // Si pas de param√®tre "type", v√©rifier dans localStorage
            if (!courseTypeParam || !['essai', 'conversation', 'curriculum'].includes(courseTypeParam)) {
                const storedCourseType = localStorage.getItem('preLoginCourseType');
                
                if (storedCourseType && ['essai', 'conversation', 'curriculum'].includes(storedCourseType)) {
                    courseTypeParam = storedCourseType;
                    localStorage.removeItem('preLoginCourseType');
                } else {
                    // Par d√©faut
                    courseTypeParam = 'essai';
                }
            }
            
            // Forcer la s√©lection dans le dropdown
            document.getElementById('courseType').value = courseTypeParam;
            preLoginCourseType = courseTypeParam;
            
            // Stocker aussi dans l'URL si ce n'est pas d√©j√† fait
            if (!urlParams.has('type')) {
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('type', courseTypeParam);
                window.history.replaceState({}, '', newUrl);
            }
            
            // Initialiser le calendrier
            initCalendar();
            
            // Charger les cr√©neaux pour aujourd'hui par d√©faut
            const today = new Date().toISOString().split('T')[0];
            selectToday(today);
            
            // Mettre √† jour l'interface
            updateUIForCourseType(document.getElementById('courseType').value, false);
        }

        function initCalendar() {
            // Mettre √† jour l'affichage du mois
            const monthNames = [
                'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
            ];
            currentMonthElement.textContent = `${monthNames[currentMonth]} ${currentYear}`;

            // G√©n√©rer les jours du mois
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();

            // En-t√™tes des jours
            const dayHeaders = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            calendarDays.innerHTML = '';

            // Ajouter les en-t√™tes
            dayHeaders.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day-header';
                dayElement.textContent = day;
                calendarDays.appendChild(dayElement);
            });

            // Ajouter les cellules vides pour le d√©but du mois
            for (let i = 0; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day disabled';
                calendarDays.appendChild(emptyDay);
            }

            // Ajouter les jours du mois
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                dayElement.setAttribute('data-date', 
                    `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`
                );
                
                // Marquer aujourd'hui
                if (date.getDate() === today.getDate() && 
                    date.getMonth() === today.getMonth() && 
                    date.getFullYear() === today.getFullYear()) {
                    dayElement.classList.add('today');
                }

                // D√©sactiver les jours pass√©s
                if (date < today) {
                    dayElement.classList.add('disabled');
                } else {
                    dayElement.addEventListener('click', () => selectDate(
                        `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`
                    ));
                }

                calendarDays.appendChild(dayElement);
            }
        }

        function selectToday(today) {
            // S√©lectionner la date d'aujourd'hui par d√©faut
            const todayElement = document.querySelector(`.calendar-day[data-date="${today}"]`);
            if (todayElement && !todayElement.classList.contains('disabled')) {
                selectDate(today);
            } else {
                // Sinon, s√©lectionner la premi√®re date disponible
                const firstAvailable = document.querySelector('.calendar-day:not(.disabled)');
                if (firstAvailable) {
                    selectDate(firstAvailable.getAttribute('data-date'));
                }
            }
        }

        function updateUIForCourseType(courseType, forceUpdate = false) {
            console.log('updateUIForCourseType appel√© avec:', courseType, 'forceUpdate:', forceUpdate);
            
            // Stocker le type de cours actuel
            preLoginCourseType = courseType;
            
            const user = window.authManager?.getCurrentUser();
            const isLoggedIn = !!user;
            
            console.log('Utilisateur connect√©:', isLoggedIn, 'User:', user);
            
            // Mettre √† jour les liens de connexion avec le type de cours actuel
            if (courseType && courseType !== 'essai') {
                const redirectUrl = `booking.html?type=${courseType}`;
                loginLink.href = `login.html?redirect=${encodeURIComponent(redirectUrl)}`;
                signupLink.href = `signup.html?redirect=${encodeURIComponent(redirectUrl)}`;
                
                // Stocker le type de cours pour apr√®s la connexion
                localStorage.setItem('preLoginCourseType', courseType);
            }
            
            // G√©rer l'affichage du s√©lecteur de dur√©e et du message de connexion
            if (courseType === 'essai') {
                // Pour essai: pas de s√©lecteur de dur√©e, toujours 15min
                durationGroup.classList.remove('visible');
                loginRequired.style.display = 'none';
            } else if (courseType === 'conversation' || courseType === 'curriculum') {
                if (isLoggedIn) {
                    // Connect√©: afficher le s√©lecteur de dur√©e
                    durationGroup.classList.add('visible');
                    loginRequired.style.display = 'none';
                    console.log('S√©lecteur de dur√©e affich√© pour', courseType);
                } else {
                    // Non connect√©: afficher message de connexion requise
                    durationGroup.classList.remove('visible');
                    loginRequired.style.display = 'block';
                    courseTypeName.textContent = courseType === 'conversation' ? 'Conversation' : 'Curriculum complet';
                    console.log('Message connexion affich√© pour', courseType);
                }
            } else {
                durationGroup.classList.remove('visible');
                loginRequired.style.display = 'none';
            }
            
            // Pr√©-remplir les infos si l'utilisateur est connect√©
            if (isLoggedIn && user) {
                document.getElementById('name').value = user.user_metadata?.full_name || user.email?.split('@')[0] || '';
                document.getElementById('email').value = user.email || '';
            }
            
            // Recharger les cr√©neaux si n√©cessaire
            if (forceUpdate && selectedDate) {
                loadAvailableSlots(selectedDate);
            }
            
            updateSummary();
        }

        async function loadAvailableSlots(date = null) {
            try {
                // Afficher un message de chargement
                timeSlots.innerHTML = '<div class="loading-slots"><i class="fas fa-spinner fa-spin"></i> Chargement des cr√©neaux...</div>';
                
                // R√©cup√©rer le type de cours s√©lectionn√©
                const courseType = document.getElementById('courseType').value || 'essai';
                
                // Pour essai: pas besoin de dur√©e
                // Pour conversation/curriculum: utiliser la dur√©e s√©lectionn√©e si connect√©
                let duration = null;
                if (courseType !== 'essai' && durationGroup.classList.contains('visible')) {
                    duration = parseInt(durationInput.value) || 60;
                }
                
                // Appeler l'API avec la date et le type de cours
                const slots = await window.bookingManager.getAvailableSlots(courseType, date, duration);
                
                timeSlots.innerHTML = '';
                
                if (slots.length === 0) {
                    timeSlots.innerHTML = '<p class="no-slots">Aucun cr√©neau disponible pour cette date.</p>';
                    return;
                }

                // Filtrer et afficher les cr√©neaux
                let hasFutureSlots = false;
                
                slots.forEach(slot => {
                    const slotDate = new Date(slot.start);
                    const now = new Date();
                    
                    // Ne montrer que les cr√©neaux futurs
                    if (slotDate > now) {
                        hasFutureSlots = true;
                        const slotElement = document.createElement('div');
                        slotElement.className = 'time-slot';
                        slotElement.innerHTML = `
                            <div class="time-slot-time">
                                <i class="far fa-clock"></i>
                                ${slotDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                            <div class="time-slot-duration">
                                ${window.bookingManager.formatTime(slot.start)} - ${slot.duration}
                            </div>
                        `;
                        
                        slotElement.addEventListener('click', () => selectTimeSlot(slot, slotElement));
                        timeSlots.appendChild(slotElement);
                    }
                });

                if (!hasFutureSlots) {
                    timeSlots.innerHTML = '<p class="no-slots">Tous les cr√©neaux sont complets pour aujourd\'hui.</p>';
                }

            } catch (error) {
                console.error('Erreur chargement cr√©neaux:', error);
                timeSlots.innerHTML = `
                    <div class="error-slots">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erreur lors du chargement des cr√©neaux</p>
                        <p class="error-details">${error.message || 'Veuillez r√©essayer'}</p>
                        <button onclick="loadAvailableSlots('${date}')" class="retry-btn">
                            <i class="fas fa-redo"></i> R√©essayer
                        </button>
                    </div>
                `;
            }
        }

        function selectDate(date) {
            selectedDate = date;
            
            // Mettre √† jour la s√©lection visuelle
            document.querySelectorAll('.calendar-day').forEach(dayEl => {
                dayEl.classList.remove('selected');
            });
            
            const selectedDayElement = document.querySelector(`.calendar-day[data-date="${date}"]`);
            if (selectedDayElement) {
                selectedDayElement.classList.add('selected');
            }
            
            loadAvailableSlots(selectedDate);
            updateSummary();
        }

        function selectTimeSlot(slot, element) {
            // Retirer la s√©lection pr√©c√©dente
            document.querySelectorAll('.time-slot').forEach(slotEl => {
                slotEl.classList.remove('selected');
            });

            // Ajouter la nouvelle s√©lection
            element.classList.add('selected');
            
            selectedSlot = slot;
            selectedTime = new Date(slot.start).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            // Mettre √† jour la dur√©e s√©lectionn√©e si le cr√©neau a une dur√©e diff√©rente
            if (slot.durationInMinutes && durationGroup.classList.contains('visible')) {
                // Trouver et s√©lectionner le bouton correspondant
                const durationButton = document.querySelector(`.duration-option[data-duration="${slot.durationInMinutes}"]`);
                if (durationButton) {
                    document.querySelectorAll('.duration-option').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    durationButton.classList.add('selected');
                    durationInput.value = slot.durationInMinutes;
                }
            }
            
            updateSummary();
        }

        function updateSummary() {
            const courseType = document.getElementById('courseType').value;
            const user = window.authManager?.getCurrentUser();
            let courseName = '-';
            let price = '-';
            let duration = '-';

            // Calculer en fonction du type de cours
            if (courseType === 'essai') {
                courseName = 'Cours d\'essai';
                price = '5‚Ç¨';
                duration = '15 min';
            } else if (courseType === 'conversation') {
                courseName = 'Conversation';
                if (user && durationGroup.classList.contains('visible')) {
                    const selectedDuration = selectedSlot ? selectedSlot.durationInMinutes : (parseInt(durationInput.value) || 60);
                    duration = selectedDuration + ' min';
                    // Tarifs conversation
                    if (selectedDuration === 30) price = '10‚Ç¨';
                    else if (selectedDuration === 45) price = '15‚Ç¨';
                    else price = '20‚Ç¨';
                } else {
                    duration = '60 min';
                    price = '20‚Ç¨';
                }
            } else if (courseType === 'curriculum') {
                courseName = 'Curriculum complet';
                if (user && durationGroup.classList.contains('visible')) {
                    const selectedDuration = selectedSlot ? selectedSlot.durationInMinutes : (parseInt(durationInput.value) || 60);
                    duration = selectedDuration + ' min';
                    // Tarifs curriculum
                    if (selectedDuration === 30) price = '17.5‚Ç¨';
                    else if (selectedDuration === 45) price = '26.25‚Ç¨';
                    else price = '35‚Ç¨';
                } else {
                    duration = '60 min';
                    price = '35‚Ç¨';
                }
            }

            document.getElementById('summaryType').textContent = courseName;
            document.getElementById('summaryDate').textContent = selectedDate ? 
                new Date(selectedDate).toLocaleDateString('fr-FR') : '-';
            document.getElementById('summaryTime').textContent = selectedTime || '-';
            document.getElementById('summaryDuration').textContent = duration;
            document.getElementById('summaryPrice').textContent = price;

            // Activer/d√©sactiver le bouton de soumission
            const canSubmit = selectedDate && selectedTime && courseType && 
                (courseType === 'essai' || (user && durationGroup.classList.contains('visible')));
            
            submitButton.disabled = !canSubmit;
        }

        function showError(message) {
            errorText.textContent = message;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
        }

        function showSuccess(message) {
            successText.textContent = message;
            successDiv.style.display = 'block';
            errorDiv.style.display = 'none';
        }

        function hideMessages() {
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
        }
    });
</script>
</body>
</html>