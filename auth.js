class e{constructor(){this.user=null,this.supabaseReady=!1,this.pendingPayment=null,this.invitationCode=null,this.init()}async init(){console.log("üîç Initialisation AuthManager...");try{if(this.checkInvitationCode(),this.syncFromLocalStorage(),this.render(),await this.waitForSupabase(),!this.supabaseReady)return void console.warn("‚ö†Ô∏è Mode d√©grad√© : Supabase non disponible");console.log("‚úÖ Supabase pr√™t");const{data:{session:e},error:t}=await supabase.auth.getSession();t&&console.warn("‚ö†Ô∏è Erreur getSession:",t.message),e?(this.user=e.user,await this.loadUserProfile(),this.saveUserToStorage(),this.render(),this.emitAuthEvent("login",this.user),console.log("‚úÖ Session restaur√©e:",this.user.email)):console.log("‚ÑπÔ∏è Aucune session active"),supabase.auth.onAuthStateChange(async(e,t)=>{console.log("üîÑ Auth state changed:",e),t?(this.user=t.user,await this.loadUserProfile(),this.saveUserToStorage(),this.render(),this.emitAuthEvent("login",this.user),await this.applyPendingInvitation()):(this.user=null,this.removeUserFromStorage(),this.render(),this.emitAuthEvent("logout"))})}catch(e){console.error("‚ùå Erreur init auth:",e)}}render(){const e=this.isAuthenticated(),t=window.location.pathname.includes("dashboard.html");console.log("üé® Render auth buttons - Authenticated:",e),e?(document.body.classList.add("user-authenticated"),document.body.classList.remove("user-not-authenticated")):(document.body.classList.add("user-not-authenticated"),document.body.classList.remove("user-authenticated")),e?this.renderAuthenticatedState(t):this.renderUnauthenticatedState(),this.updatePageButtons()}renderAuthenticatedState(e){const t=document.querySelector(".header-right-group .login-btn");t&&!e&&(document.querySelector(".header-right-group .user-avatar")||this.createUserAvatar(t));const s=document.querySelector(".mobile-header-right-group .mobile-login-btn-header");s&&!e&&(document.querySelector(".mobile-header-right-group .mobile-dashboard-btn")||this.createMobileDashboardBtn(s))}renderUnauthenticatedState(){document.querySelector(".header-right-group .user-avatar")&&this.removeUserAvatar();document.querySelector(".mobile-header-right-group .mobile-dashboard-btn")&&this.removeMobileDashboardBtn()}createUserAvatar(e){const t=document.createElement("div");t.className="user-avatar";const s=this.getUserInitials();t.innerHTML=`\n            <a href="dashboard.html" class="dashboard-btn">\n                <div class="avatar-img">${s}</div>\n                <span>Dashboard</span>\n                <button class="logout-btn-icon" type="button" title="D√©connexion">√ó</button>\n            </a>\n        `,e.replaceWith(t);const r=t.querySelector(".logout-btn-icon");r&&r.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),confirm("Voulez-vous vraiment vous d√©connecter ?")&&this.signOut()});const o=t.querySelector(".dashboard-btn");o&&o.addEventListener("click",e=>{e.target.closest(".logout-btn-icon")||(e.preventDefault(),window.location.href="dashboard.html")})}removeUserAvatar(){const e=document.querySelector(".header-right-group .user-avatar");if(e){const t=document.createElement("a");t.href="login.html",t.className="login-btn",t.textContent="Connexion",t.setAttribute("data-i18n","header.login"),e.replaceWith(t)}}createMobileDashboardBtn(e){const t=document.createElement("a");t.href="dashboard.html",t.className="mobile-dashboard-btn";const s=this.getUserInitials();t.innerHTML=`\n            <div class="avatar-img">${s}</div>\n            <span>Dashboard</span>\n        `,e.replaceWith(t)}removeMobileDashboardBtn(){const e=document.querySelector(".mobile-header-right-group .mobile-dashboard-btn");if(e){const t=document.createElement("a");t.href="login.html",t.className="mobile-login-btn-header",t.textContent="Connexion",t.setAttribute("data-i18n","header.login"),e.replaceWith(t)}}updatePageButtons(){const e=window.location.pathname.includes("index.html")||"/"===window.location.pathname||window.location.pathname.endsWith("/"),t=window.location.pathname.includes("dashboard.html");e||t||(this.isAuthenticated()?this.updateAllButtonsForConnectedUser():this.restoreAllButtonsForDisconnectedUser())}updateAllButtonsForConnectedUser(){document.querySelectorAll(".btn-secondary, .btn-outline-white").forEach(e=>{if(!e||!e.textContent)return;const t=e.textContent.toLowerCase();(t.includes("cr√©er")||t.includes("creer")||e.href&&(e.href.includes("signup.html")||"#"===e.href))&&(e.textContent="Mon dashboard",e.href="dashboard.html",e.classList.contains("btn-outline-white")?(e.classList.remove("btn-outline-white"),e.classList.add("btn-outline")):e.classList.contains("btn-secondary")&&(e.classList.remove("btn-secondary"),e.classList.add("btn-primary")))})}restoreAllButtonsForDisconnectedUser(){document.querySelectorAll(".btn-outline, .btn-primary").forEach(e=>{if(!e||!e.textContent)return;const t=e.textContent.toLowerCase();(t.includes("dashboard")||t.includes("mon dashboard")||e.href&&"dashboard.html"===e.href)&&(e.textContent="Cr√©er un compte gratuit",e.href="signup.html",e.classList.contains("btn-outline")?(e.classList.remove("btn-outline"),e.classList.add("btn-outline-white")):e.classList.contains("btn-primary")&&(e.classList.remove("btn-primary"),e.classList.add("btn-secondary")))})}getUserInitials(){if(!this.user)return"?";const e=this.user.profile?.full_name||this.user.user_metadata?.full_name||"",t=this.user.email||"";if(e){const t=e.split(" ");return t.length>=2?(t[0][0]+t[1][0]).toUpperCase():t[0][0]?t[0][0].toUpperCase():"?"}return t.substring(0,2).toUpperCase()||"?"}isAuthenticated(){return!!this.user}getCurrentUser(){return this.user}syncFromLocalStorage(){const e=localStorage.getItem("yoteacher_user");if(e&&!this.user)try{this.user=JSON.parse(e),console.log("‚úÖ Utilisateur synchronis√© depuis localStorage")}catch(e){console.error("‚ùå Erreur synchronisation:",e)}}saveUserToStorage(){if(this.user){const e={...this.user,_timestamp:Date.now()};localStorage.setItem("yoteacher_user",JSON.stringify(e)),console.log("üíæ Utilisateur sauvegard√©")}}removeUserFromStorage(){localStorage.removeItem("yoteacher_user"),console.log("üóëÔ∏è Utilisateur supprim√©")}async signIn(e,t){try{if(!this.supabaseReady||!window.supabase)return{success:!1,error:"Service indisponible"};const{data:s,error:r}=await supabase.auth.signInWithPassword({email:e,password:t});return r?(console.error("‚ùå Erreur signIn:",r),{success:!1,error:r.message}):s.user?(this.user=s.user,await this.loadUserProfile(),this.saveUserToStorage(),this.render(),this.emitAuthEvent("login",this.user),{success:!0,user:s.user,redirectUrl:"dashboard.html"}):{success:!1,error:"Connexion √©chou√©e"}}catch(e){return console.error("‚ùå Exception signIn:",e),{success:!1,error:e.message}}}async signUp(e,t,s){try{if(!this.supabaseReady||!window.supabase)return{success:!1,error:"Service indisponible"};const{data:r,error:o}=await supabase.auth.signUp({email:e,password:t,options:{data:{full_name:s}}});return o?(console.error("‚ùå Erreur signUp:",o),{success:!1,error:o.message}):r.user?(this.user=r.user,await this.createUserProfile(s),this.saveUserToStorage(),this.render(),this.emitAuthEvent("login",this.user),{success:!0,user:r.user}):{success:!1,error:"Inscription √©chou√©e"}}catch(e){return console.error("‚ùå Exception signUp:",e),{success:!1,error:e.message}}}async signOut(){try{this.supabaseReady&&window.supabase&&await supabase.auth.signOut(),this.user=null,this.removeUserFromStorage(),this.render(),this.emitAuthEvent("logout"),console.log("‚úÖ D√©connexion r√©ussie"),window.location.pathname.includes("index.html")||(window.location.href="index.html")}catch(e){console.error("‚ùå Erreur signOut:",e)}}async loadUserProfile(){if(this.supabaseReady&&window.supabase&&this.user)try{const{data:e,error:t}=await supabase.from("profiles").select("*").eq("id",this.user.id).maybeSingle();if(t)return void console.warn("‚ö†Ô∏è Erreur chargement profil:",t);e&&(this.user.profile=e,console.log("‚úÖ Profil charg√©"))}catch(e){console.error("‚ùå Exception profil:",e)}}async createUserProfile(e){if(this.supabaseReady&&window.supabase&&this.user)try{const{error:t}=await supabase.from("profiles").insert({id:this.user.id,full_name:e,is_vip:!1,created_at:(new Date).toISOString()});t?console.warn("‚ö†Ô∏è Erreur cr√©ation profil:",t):console.log("‚úÖ Profil cr√©√©")}catch(e){console.error("‚ùå Exception cr√©ation profil:",e)}}emitAuthEvent(e,t=null){const s=new CustomEvent(`auth:${e}`,{detail:t});window.dispatchEvent(s)}async waitForSupabase(){if(window.supabaseInitialized){const e=await window.supabaseInitialized;return this.supabaseReady=e,e}let e=0;for(;!window.supabase&&e<30;)await new Promise(e=>setTimeout(e,100)),e++;return this.supabaseReady=!!window.supabase,this.supabaseReady}checkInvitationCode(){const e=new URLSearchParams(window.location.search).get("code");if(e)return console.log("üéüÔ∏è Code VIP d√©tect√©:",e),this.invitationCode=e,sessionStorage.setItem("invitation_code",e),this.showInvitationNotification(e),e;const t=sessionStorage.getItem("invitation_code");return t?(console.log("üéüÔ∏è Code VIP en attente:",t),this.invitationCode=t,t):null}showInvitationNotification(e){const t=document.createElement("div");if(t.id="invitation-notification",t.style.cssText="\n            position: fixed;\n            top: 80px;\n            left: 50%;\n            transform: translateX(-50%);\n            background: linear-gradient(135deg, #FFD700, #FFA500);\n            color: #000;\n            padding: 15px 30px;\n            border-radius: 50px;\n            box-shadow: 0 10px 30px rgba(255, 165, 0, 0.3);\n            z-index: 10000;\n            font-weight: 600;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n            animation: slideDown 0.5s ease;\n        ",t.innerHTML=`\n            <i class="fas fa-crown" style="font-size: 1.2rem;"></i>\n            <span>Code VIP appliqu√© : <strong>${e}</strong></span>\n            <i class="fas fa-check-circle" style="color: #2e7d32;"></i>\n        `,!document.getElementById("invitation-styles")){const e=document.createElement("style");e.id="invitation-styles",e.textContent="\n                @keyframes slideDown {\n                    from {\n                        opacity: 0;\n                        transform: translateX(-50%) translateY(-100%);\n                    }\n                    to {\n                        opacity: 1;\n                        transform: translateX(-50%) translateY(0);\n                    }\n                }\n            ",document.head.appendChild(e)}document.body.appendChild(t),setTimeout(()=>{t.parentElement&&(t.style.transition="all 0.3s ease",t.style.opacity="0",t.style.transform="translateX(-50%) translateY(-100%)",setTimeout(()=>t.remove(),300))},5e3)}async applyPendingInvitation(){const e=this.invitationCode||sessionStorage.getItem("invitation_code");e&&this.user&&(console.log("üéüÔ∏è Application code VIP:",e),await this.applyInvitationCode(e))}async applyInvitationCode(e){if(!this.supabaseReady||!window.supabase||!this.user)return console.warn("‚ö†Ô∏è Impossible d'appliquer le code VIP : Supabase ou utilisateur non disponible"),{success:!1,error:"Service non disponible"};try{console.log("üéüÔ∏è Application du code VIP:",e);const{data:t,error:s}=await supabase.from("vip_pricing").select("id, course_type, duration_minutes, price, currency, invitation_code").is("user_id",null).eq("invitation_code",e);if(s)return console.error("‚ùå Erreur recherche code VIP:",s),{success:!1,error:"Erreur lors de la v√©rification du code"};if(!t||0===t.length)return console.warn("‚ö†Ô∏è Code VIP invalide:",e),{success:!1,error:"Code VIP invalide"};console.log("‚úÖ Code VIP valide trouv√© avec",t.length,"tarifs");const{data:r,error:o}=await supabase.from("vip_pricing").select("id, invitation_code").eq("user_id",this.user.id);if(o)return console.error("‚ùå Erreur v√©rification tarifs existants:",o),{success:!1,error:"Erreur lors de la v√©rification"};if(r&&r.length>0)return console.warn("‚ö†Ô∏è L'utilisateur a d√©j√† des tarifs VIP:",r[0].invitation_code),{success:!1,error:`Vous avez d√©j√† un code VIP appliqu√© (${r[0].invitation_code||"code inconnu"})`};const{error:n}=await supabase.from("vip_pricing").update({user_id:this.user.id}).is("user_id",null).eq("invitation_code",e);if(n)return console.error("‚ùå Erreur mise √† jour tarifs VIP:",n),{success:!1,error:"Erreur lors de l'application du code VIP"};console.log("‚úÖ Tarifs VIP mis √† jour avec user_id:",this.user.id);const{error:i}=await supabase.from("profiles").update({is_vip:!0}).eq("id",this.user.id);return i?(console.error("‚ùå Erreur mise √† jour profil VIP:",i),{success:!1,error:"Erreur lors de l'activation du statut VIP"}):(console.log("‚úÖ Profil utilisateur marqu√© comme VIP"),await this.loadUserProfile(),sessionStorage.removeItem("invitation_code"),this.invitationCode=null,console.log("üéâ Code VIP appliqu√© avec succ√®s !"),{success:!0})}catch(e){return console.error("‚ùå Exception lors de l'application du code VIP:",e),{success:!1,error:e.message}}}isUserVip(){return this.user&&this.user.profile&&!0===this.user.profile.is_vip}}document.addEventListener("DOMContentLoaded",function(){console.log("üöÄ Initialisation AuthManager..."),window.authManager=new e}),window.addEventListener("auth:login",function(e){console.log("‚úÖ Login:",e.detail?.user?.email||"sans email")}),window.addEventListener("auth:logout",function(){console.log("‚ö†Ô∏è Logout")}),console.log("‚úÖ auth.js charg√© - Version d√©terministe");
