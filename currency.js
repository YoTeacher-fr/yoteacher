class e{constructor(){this.config=window.YOTEACHER_CONFIG||{},this.baseCurrency="EUR",this.currentCurrency="EUR",this.exchangeRates={},this.isLoading=!1,this.supportedCurrencies=["USD","EUR","GBP","CAD","AUD","CHF","JPY","CNY","SGD","HKD","NZD","SEK","NOK","DKK","PLN","MXN","BRL","INR","RUB","TRY","ZAR","AED","SAR","THB","KRW","MYR"],this.currencySymbols={USD:"$",EUR:"â‚¬",GBP:"Â£",CAD:"CA$",AUD:"A$",CHF:"CHF",JPY:"Â¥",CNY:"Â¥",SGD:"S$",HKD:"HK$",NZD:"NZ$",SEK:"kr",NOK:"kr",DKK:"kr",PLN:"zÅ‚",MXN:"$",BRL:"R$",INR:"â‚¹",RUB:"â‚½",TRY:"â‚º",ZAR:"R",AED:"Ø¯.Ø¥",SAR:"ï·¼",THB:"à¸¿",KRW:"â‚©",MYR:"RM"},this.currencyPositions={USD:!0,EUR:!0,GBP:!0,CAD:!0,AUD:!0,CHF:!0,JPY:!0,CNY:!0,SGD:!0,HKD:!0,NZD:!0,SEK:!1,NOK:!1,DKK:!1,PLN:!1,MXN:!0,BRL:!0,INR:!0,RUB:!1,TRY:!0,ZAR:!0,AED:!0,SAR:!0,THB:!0,KRW:!0,MYR:!0},console.log("ğŸ’± CurrencyManager initialisÃ©")}async init(){try{console.log("ğŸ’± DÃ©but de l'initialisation de CurrencyManager"),await this.loadExchangeRates();const e=localStorage.getItem("preferredCurrency");return e&&this.supportedCurrencies.includes(e)?(this.currentCurrency=e,console.log(`ğŸ’± Devise restaurÃ©e: ${this.currentCurrency}`)):await this.detectUserCurrency(),this.initCurrencySelectors(),console.log("âœ… CurrencyManager prÃªt, Ã©mission d'Ã©vÃ©nement"),window.dispatchEvent(new CustomEvent("currency:ready",{detail:{currency:this.currentCurrency,rates:this.exchangeRates,symbol:this.getSymbol()}})),window.dispatchEvent(new CustomEvent("currency:initialized")),!0}catch(e){return console.error("âŒ Erreur initialisation CurrencyManager:",e),this.exchangeRates=this.getStaticRates(),this.exchangeRates.EUR=1,this.currentCurrency="EUR",window.dispatchEvent(new CustomEvent("currency:ready",{detail:{currency:this.currentCurrency,rates:this.exchangeRates,symbol:this.getSymbol()}})),!0}}async detectUserCurrency(){try{const e=navigator.language||navigator.userLanguage,r=e.split("-")[1]||e.split("_")[1];if(r){const e={US:"USD",GB:"GBP",CA:"CAD",AU:"AUD",JP:"JPY",CN:"CNY",SG:"SGD",HK:"HKD",NZ:"NZD",SE:"SEK",NO:"NOK",DK:"DKK",PL:"PLN",MX:"MXN",BR:"BRL",IN:"INR",RU:"RUB",TR:"TRY",ZA:"ZAR",AE:"AED",SA:"SAR",TH:"THB",KR:"KRW",MY:"MYR",CH:"CHF",FR:"EUR",DE:"EUR",ES:"EUR",IT:"EUR",NL:"EUR",BE:"EUR",PT:"EUR",IE:"EUR",AT:"EUR",FI:"EUR",GR:"EUR",LU:"EUR",SK:"EUR",SI:"EUR",CY:"EUR",MT:"EUR",EE:"EUR",LV:"EUR",LT:"EUR"}[r.toUpperCase()];if(e&&this.supportedCurrencies.includes(e))return this.currentCurrency=e,void console.log(`ğŸ’± Devise dÃ©tectÃ©e: ${this.currentCurrency} (${r})`)}const n=Intl.DateTimeFormat().resolvedOptions().timeZone;n.includes("America/New_York")||n.includes("America/Los_Angeles")||n.includes("America/Chicago")||n.includes("America/Toronto")?this.currentCurrency="USD":n.includes("Europe/London")?this.currentCurrency="GBP":n.includes("Canada")?this.currentCurrency="CAD":n.includes("Australia")?this.currentCurrency="AUD":n.includes("Japan")?this.currentCurrency="JPY":n.includes("Europe")?this.currentCurrency="EUR":n.includes("Asia/Hong_Kong")?this.currentCurrency="HKD":n.includes("Asia/Singapore")&&(this.currentCurrency="SGD"),console.log(`ğŸ’± Devise dÃ©tectÃ©e (fuseau): ${this.currentCurrency}`)}catch(e){console.warn("âš ï¸ Erreur dÃ©tection devise, utilisation EUR par dÃ©faut:",e),this.currentCurrency="EUR"}}async loadExchangeRates(){try{this.isLoading=!0,console.log("ğŸ’± DÃ©but du chargement des taux de change");const e=localStorage.getItem("exchangeRates");if(e)try{const{rates:r,timestamp:n,expiresAt:t}=JSON.parse(e),c=Date.now();if(r&&t>c)return this.exchangeRates=r,console.log("ğŸ’¾ Taux de change restaurÃ©s depuis le cache:",Object.keys(r).length+" devises"),this.isLoading=!1,r}catch(e){console.warn("âš ï¸ Erreur cache taux:",e)}const r=this.getStaticRates();r.EUR=1,this.exchangeRates=r,console.log("ğŸ’° Taux statiques chargÃ©s (fallback):",Object.keys(r).length+" devises");const n=["https://api.frankfurter.app/latest?from=EUR","https://api.exchangerate-api.com/v4/latest/EUR","https://open.er-api.com/v6/latest/EUR"].map(e=>this.fetchExchangeRates(e).catch(r=>(console.log(`âš ï¸ API ${e} Ã©chouÃ©e:`,r.message),null))),t=await Promise.allSettled(n);for(const e of t)if("fulfilled"===e.status&&e.value){this.exchangeRates={...r,...e.value},this.exchangeRates.EUR=1,console.log("âœ… Taux API chargÃ©s:",Object.keys(this.exchangeRates).length+" devises");break}return this.exchangeRates.USD||(this.exchangeRates.USD=1.08,console.warn("âš ï¸ USD manquant, valeur par dÃ©faut ajoutÃ©e")),this.exchangeRates.EUR||(this.exchangeRates.EUR=1),this.isLoading=!1,localStorage.setItem("exchangeRates",JSON.stringify({rates:this.exchangeRates,timestamp:Date.now(),expiresAt:Date.now()+36e5})),console.log("âœ… Taux de change finalisÃ©s:",this.exchangeRates),window.dispatchEvent(new CustomEvent("exchangeRates:loaded",{detail:{rates:this.exchangeRates}})),this.exchangeRates}catch(e){return console.error("âŒ Erreur critique chargement taux:",e),this.exchangeRates=this.getStaticRates(),this.exchangeRates.EUR=1,this.isLoading=!1,this.exchangeRates}}async fetchExchangeRates(e){return new Promise(async(r,n)=>{const t=new AbortController,c=setTimeout(()=>t.abort(),5e3);try{console.log(`ğŸ”— Tentative API: ${e}`);const o=await fetch(e,{signal:t.signal,headers:{Accept:"application/json"}});if(clearTimeout(c),!o.ok)return void n(new Error(`HTTP ${o.status}`));const s=await o.json();let i={};s.rates?i=s.rates:s.conversion_rates?i=s.conversion_rates:s.rates&&s.base&&(i=s.rates),i&&i.USD&&i.EUR?r(i):n(new Error("Format de rÃ©ponse invalide"))}catch(e){clearTimeout(c),"AbortError"===e.name?n(new Error("Timeout")):n(e)}})}getStaticRates(){return{USD:1.08,EUR:1,GBP:.86,CAD:1.46,AUD:1.65,CHF:.95,JPY:163.5,CNY:7.8,SGD:1.45,HKD:8.45,NZD:1.78,SEK:11.35,NOK:11.65,DKK:7.46,PLN:4.32,MXN:18.5,BRL:5.4,INR:90.2,RUB:99.8,TRY:34.9,ZAR:20.4,AED:3.97,SAR:4.05,THB:38.9,KRW:1445,MYR:5.1}}convert(e,r="EUR",n=null){if(n||(n=this.currentCurrency),isNaN(e)||null==e)return console.warn("âŒ Montant invalide pour conversion:",e),0;if(e=parseFloat(e),r===n)return e;this.exchangeRates&&0!==Object.keys(this.exchangeRates).length||(console.warn("ğŸš¨ Taux vides, chargement d'urgence..."),this.exchangeRates=this.getStaticRates(),this.exchangeRates.EUR=1);let t=this.exchangeRates[r],c=this.exchangeRates[n];void 0===t&&(console.warn(`âš ï¸ Taux ${r} manquant, utilisation 1`),t=1),void 0===c&&(console.warn(`âš ï¸ Taux ${n} manquant, utilisation 1`),c=1);return parseFloat((("EUR"===r?e:e/t)*c).toFixed(2))}formatPrice(e,r=null,n=!0){r||(r=this.currentCurrency);const t=this.convert(e,"EUR",r),c=this.currencySymbols[r]||r,o=!1!==this.currencyPositions[r];let s;switch(r){case"JPY":case"KRW":case"VND":case"IDR":s=Math.round(t).toLocaleString();break;case"INR":s=t.toLocaleString("en-IN",{minimumFractionDigits:0,maximumFractionDigits:0});break;default:s=t.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}return n?o?`${c}${s}`:`${s} ${c}`:s}formatPriceInCurrency(e,r,n=!0){const t=this.currencySymbols[r]||r,c=!1!==this.currencyPositions[r];let o;switch(r){case"JPY":case"KRW":case"VND":case"IDR":o=Math.round(e).toLocaleString();break;case"INR":o=e.toLocaleString("en-IN",{minimumFractionDigits:0,maximumFractionDigits:0});break;default:o=e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}return n?c?`${t}${o}`:`${o} ${t}`:o}setCurrency(e){if(!this.supportedCurrencies.includes(e))return console.warn(`âŒ Devise non supportÃ©e: ${e}`),!1;const r=this.currentCurrency;return this.currentCurrency=e,localStorage.setItem("preferredCurrency",e),console.log(`ğŸ’± Devise changÃ©e: ${r} â†’ ${e}`),this.updateCurrencySelectors(),window.dispatchEvent(new CustomEvent("currency:changed",{detail:{from:r,to:e,rates:this.exchangeRates}})),!0}initCurrencySelectors(){console.log("ğŸ’± Initialisation des sÃ©lecteurs de devise"),document.querySelectorAll('select[id^="currencySelector"]').forEach(e=>{this.initSingleSelector(e)});const e=document.getElementById("currencySelectorMobile");e&&this.initSingleSelector(e),console.log("âœ… SÃ©lecteurs de devise initialisÃ©s")}initSingleSelector(e){e&&(e.innerHTML="",this.supportedCurrencies.forEach(r=>{const n=document.createElement("option");n.value=r;const t=this.currencySymbols[r]||r;n.textContent=`${t} ${r}`,r===this.currentCurrency&&(n.selected=!0),e.appendChild(n)}),e.addEventListener("change",e=>{const r=e.target.value;this.setCurrency(r)}))}updateCurrencySelectors(){console.log("ğŸ’± Mise Ã  jour des sÃ©lecteurs de devise"),document.querySelectorAll('select[id*="currencySelector"]').forEach(e=>{e.value!==this.currentCurrency&&(e.value=this.currentCurrency)})}getSymbol(e=null){return e||(e=this.currentCurrency),this.currencySymbols[e]||e}isInteracCurrency(){return"CAD"===this.currentCurrency}async forceCADForInterac(){if("CAD"!==this.currentCurrency){console.log(`ğŸ’± Interac dÃ©tectÃ©, passage de ${this.currentCurrency} Ã  CAD`);const e=this.currentCurrency;localStorage.setItem("previousCurrency",e);return this.setCurrency("CAD")}return!0}restorePreviousCurrency(){const e=localStorage.getItem("previousCurrency");return!(!e||!this.supportedCurrencies.includes(e))&&(console.log(`ğŸ’± Restauration devise prÃ©cÃ©dente: ${e}`),this.setCurrency(e),localStorage.removeItem("previousCurrency"),!0)}convertVIPPrice(e,r=null){if(!e||void 0===e.price)return console.warn("âŒ DonnÃ©es VIP manquantes pour conversion"),null;r||(r=this.currentCurrency);const n=parseFloat(e.price),t=e.currency||"USD";if(t===r)return{price:n,currency:r,originalPrice:n,originalCurrency:t,display:this.formatPriceInCurrency(n,r),converted:!1};const c=this.exchangeRates[t],o=this.exchangeRates[r];if(!c||!o){console.warn(`âš ï¸ Taux non disponibles pour ${t} â†’ ${r}`),console.warn("Taux disponibles:",Object.keys(this.exchangeRates));const e=this.exchangeRates[t]||1,c=this.exchangeRates[r]||1;if(e&&c){const o=n/e,s=o*c;return console.log(`ğŸ’± Conversion via EUR: ${n} ${t} â†’ ${o.toFixed(2)} EUR â†’ ${s.toFixed(2)} ${r}`),{price:s,currency:r,originalPrice:n,originalCurrency:t,display:this.formatPriceInCurrency(s,r),converted:!0}}return console.warn("âš ï¸ Conversion impossible, prix original retournÃ©"),{price:n,currency:t,originalPrice:n,originalCurrency:t,display:this.formatPriceInCurrency(n,t),converted:!1}}const s=n/c*o;return{price:s,currency:r,originalPrice:n,originalCurrency:t,display:this.formatPriceInCurrency(s,r),converted:!0}}formatVIPPrice(e,r=!1){if(!e||void 0===e.price)return"N/A";const n=this.convertVIPPrice(e);if(!n)return"N/A";if(r&&n.converted){const r=this.formatPriceInCurrency(e.price,e.currency||"USD");return`${n.display} (original: ${r})`}return n.display}formatWithSymbol(e,r=null){r||(r=this.currentCurrency);const n=this.formatPriceInCurrency(e,r,!1),t=this.currencySymbols[r]||r;return!1!==this.currencyPositions[r]?`${t}${n}`:`${n} ${t}`}roundForCurrency(e,r=null){switch(r||(r=this.currentCurrency),r){case"JPY":case"KRW":case"VND":case"IDR":return Math.round(e);default:return Math.round(100*e)/100}}getCurrencyInfo(e=null){return e||(e=this.currentCurrency),{code:e,symbol:this.currencySymbols[e]||e,position:!1!==this.currencyPositions[e]?"before":"after",decimals:["JPY","KRW","VND","IDR"].includes(e)?0:2,isSupported:this.supportedCurrencies.includes(e),exchangeRate:this.exchangeRates[e]||1}}}window.currencyManager=new e,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{console.log("ğŸŒ DOM chargÃ©, initialisation CurrencyManager"),window.currencyManager.init().then(()=>{console.log("âœ… CurrencyManager initialisÃ© avec succÃ¨s")}).catch(e=>{console.error("âŒ Erreur initialisation CurrencyManager:",e)})}):(console.log("ğŸŒ DOM dÃ©jÃ  chargÃ©, initialisation CurrencyManager"),window.currencyManager.init().then(()=>{console.log("âœ… CurrencyManager initialisÃ© avec succÃ¨s")}).catch(e=>{console.error("âŒ Erreur initialisation CurrencyManager:",e)})),window.formatCurrency=(e,r=null)=>window.currencyManager?window.currencyManager.formatPrice(e,r):(console.warn("âš ï¸ CurrencyManager non disponible pour formatCurrency"),`${e}â‚¬`),window.convertCurrency=(e,r="EUR",n=null)=>window.currencyManager?window.currencyManager.convert(e,r,n):(console.warn("âš ï¸ CurrencyManager non disponible pour convertCurrency"),e),window.formatPriceInCurrency=(e,r,n=!0)=>window.currencyManager?window.currencyManager.formatPriceInCurrency(e,r,n):(console.warn("âš ï¸ CurrencyManager non disponible pour formatPriceInCurrency"),`${e} ${r||"EUR"}`),window.debugCurrency=()=>{if(console.group("ğŸš¨ Debug CurrencyManager COMPLET"),!window.currencyManager)return console.error("âŒ currencyManager non disponible"),void console.groupEnd();const e=window.currencyManager;console.log("ğŸ“Š Informations gÃ©nÃ©rales:"),console.log("Devise actuelle:",e.currentCurrency),console.log("Symbole:",e.getSymbol()),console.log("Taux chargÃ©s:",Object.keys(e.exchangeRates||{}).length),console.log("Est en chargement:",e.isLoading),console.log("Devises supportÃ©es:",e.supportedCurrencies.length),console.log("\nğŸ’± Taux de change clÃ©s:");["EUR","USD","CAD","GBP","AUD","JPY","CHF"].forEach(r=>{console.log(`${r}:`,e.exchangeRates[r])}),console.log("\nğŸ§ª Test de conversion standard:"),console.log("10 EUR â†’ USD:",e.convert(10,"EUR","USD")),console.log("10 EUR â†’ CAD:",e.convert(10,"EUR","CAD")),console.log("10 EUR â†’ EUR:",e.convert(10,"EUR","EUR")),console.log("10 USD â†’ EUR:",e.convert(10,"USD","EUR")),console.log("\nğŸ‘‘ Test conversion VIP:");const r=e.convertVIPPrice({price:3,currency:"USD"},"EUR");console.log("3 USD â†’ EUR (VIP):",r),console.log("\nğŸ’° Test formatage:"),console.log("Format 10 EUR:",e.formatPrice(10)),console.log("Format 10 USD:",e.formatPrice(10,"USD")),console.log("Format 10 JPY:",e.formatPrice(10,"JPY")),console.log("Format 10 CAD:",e.formatPrice(10,"CAD")),console.log("\nğŸ“¦ Test forfait VIP (10 cours Ã  3$ avec 5% rÃ©duction):");const n=28.5;if(console.log(`Calcul: 3$ Ã— 10 Ã— (1 - 5%) = ${n.toFixed(2)}$`),"USD"!==e.currentCurrency){const r=e.convert(n,"USD",e.currentCurrency);console.log(`Conversion: ${n.toFixed(2)}$ â†’ ${r.toFixed(2)} ${e.currentCurrency}`)}console.groupEnd()},window.testVipPackages=()=>{console.group("ğŸ§ª TEST FORFAITS VIP");const e="USD";[{quantity:1,discount:0,description:"1 cours - pas de rÃ©duction"},{quantity:5,discount:2,description:"5 cours - 2% rÃ©duction"},{quantity:10,discount:5,description:"10 cours - 5% rÃ©duction"}].forEach(r=>{console.log(`\nğŸ“Š ${r.description}`);const n=3*r.quantity*(1-r.discount/100);if(console.log(`Calcul: 3${e} Ã— ${r.quantity} Ã— (1 - ${r.discount}%) = ${n.toFixed(2)}${e}`),window.currencyManager&&window.currencyManager.currentCurrency!==e){const r=window.currencyManager.convert(n,e,window.currencyManager.currentCurrency);console.log(`Conversion: ${n.toFixed(2)}${e} â†’ ${r.toFixed(2)}${window.currencyManager.currentCurrency}`)}}),console.groupEnd()},("localhost"===window.location.hostname||window.location.hostname.includes("127.0.0.1"))&&setTimeout(()=>{console.log("ğŸ§ª Test automatique CurrencyManager aprÃ¨s 3 secondes..."),window.currencyManager&&window.currencyManager.exchangeRates&&0!==Object.keys(window.currencyManager.exchangeRates).length||(console.warn("ğŸš¨ DÃ‰TECTION: Taux vides, appel debug automatique"),window.debugCurrency()),console.log("\nğŸ Test automatique des forfaits VIP"),window.testVipPackages()},3e3),window.debugVIPPriceIssue=function(){console.group("ğŸ” DEBUG PRIX VIP"),window.currencyManager&&(console.log("ğŸ’± CurrencyManager:"),console.log("- Devise courante:",window.currencyManager.currentCurrency),console.log("- Symbole:",window.currencyManager.getSymbol()),console.log("- Taux USD:",window.currencyManager.exchangeRates.USD),console.log("- Taux EUR:",window.currencyManager.exchangeRates.EUR)),window.authManager&&(console.log("ğŸ” AuthManager:"),console.log("- Utilisateur VIP:",window.authManager.isUserVip()),console.log("- Utilisateur:",window.authManager.user?.email),console.log("- Prix VIP chargÃ©s:",window.authManager.user?.vipPrices)),console.log("ğŸ§ª Test conversion 28.50 USD:");const e=28.5;if(window.currencyManager){const r=window.currencyManager.convert(e,"USD",window.currencyManager.currentCurrency);console.log(`28.5 USD â†’ ${r.toFixed(2)} ${window.currencyManager.currentCurrency}`);const n=r/e;console.log(`Taux implicite USDâ†’${window.currencyManager.currentCurrency}:`,n.toFixed(4))}console.log("ğŸ§® Calcul manuel:");const r=28.5;if(console.log(`3 USD Ã— 10 Ã— (1 - 5%) = ${r.toFixed(2)} USD`),window.currencyManager){const e=window.currencyManager.convert(r,"USD",window.currencyManager.currentCurrency);console.log(`â†’ ${e.toFixed(2)} ${window.currencyManager.currentCurrency}`)}console.groupEnd()},"undefined"!=typeof module&&module.exports&&(module.exports={CurrencyManager:e});
